<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Kisaki Admin Realtime</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <style>
    /* --- VARIABLES & RESET --- */
    :root {
      --bg-core: #020617;
      --card-bg: #0f172a;
      --text-main: #f8fafc;
      --text-sec: #94a3b8;
      --grad-ocean: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%);
      --grad-electric: linear-gradient(135deg, #2563eb 0%, #06b6d4 100%);
      --border-glass: rgba(255,255,255,0.08);
      --accent-blue: #3b82f6;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'SF Pro Display', 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }

    body {
      background-color: var(--bg-core);
      color: var(--text-main);
      min-height: 100vh;
      display: flex; flex-direction: column;
      overflow-x: hidden;
    }

    /* --- LAYOUT --- */
    .view-container { padding: 24px; display: none; animation: fadeScale 0.3s; }
    .view-container.active { display: block; }

    /* --- NAV --- */
    .nav-header { display: flex; align-items: center; gap: 15px; margin-bottom: 30px; }
    .btn-back {
      width: 40px; height: 40px; border-radius: 12px;
      background: rgba(255,255,255,0.05); border: 1px solid var(--border-glass);
      display: flex; align-items: center; justify-content: center; color: white; cursor: pointer;
    }

    /* --- MENU GRID --- */
    .menu-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
    .menu-card {
      background: var(--card-bg); border-radius: 24px; padding: 25px;
      border: 1px solid var(--border-glass); height: 160px; 
      display: flex; flex-direction: column; justify-content: flex-end; cursor: pointer;
    }
    .menu-admins { background: var(--grad-ocean); }
    
    .icon-box {
      position: absolute; top: 20px; left: 20px; width: 50px; height: 50px; 
      background: rgba(255,255,255,0.1); border-radius: 16px; 
      display: flex; align-items: center; justify-content: center;
    }

    /* --- LISTAS --- */
    .list-item {
      background: linear-gradient(90deg, #0f172a 0%, #020617 100%);
      padding: 14px; border-radius: 18px; margin-bottom: 12px;
      display: flex; align-items: center; justify-content: space-between;
      border: 1px solid var(--border-glass);
    }
    .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7em; background: rgba(37, 99, 235, 0.2); color: #60a5fa; }

    /* --- PERMISOS --- */
    .perm-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 30px; }
    .perm-item {
      display: flex; align-items: center; gap: 15px; padding: 12px;
      background: #0f0f0f; border-radius: 12px; cursor: pointer;
    }
    .custom-check {
      width: 22px; height: 22px; border: 2px solid #333; border-radius: 6px;
      display: flex; align-items: center; justify-content: center; transition: 0.2s;
    }
    .custom-check.checked { background: var(--accent-blue); border-color: var(--accent-blue); }
    .custom-check svg { display: none; width: 14px; stroke: white; stroke-width: 3; }
    .custom-check.checked svg { display: block; }

    .btn-save {
      width: 100%; background: var(--grad-electric); color: white; padding: 16px;
      border-radius: 16px; border: none; font-weight: 700; font-size: 1.1em;
      cursor: pointer; box-shadow: 0 4px 20px rgba(37, 99, 235, 0.4);
    }

    /* --- GR√ÅFICAS --- */
    .chart-wrapper { background: #0f172a; border-radius: 20px; padding: 15px; margin-bottom: 20px; border: 1px solid var(--border-glass); }

    @keyframes fadeScale { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
  </style>
</head>
<body>

  <div id="viewHome" class="view-container active">
    <div style="margin: 20px 0 40px 0;">
      <h1 style="font-size: 2em; font-weight: 800;">Panel Kisaki</h1>
      <p style="color: var(--text-sec);">Gesti√≥n en tiempo real</p>
    </div>

    <div class="menu-grid">
      <div class="menu-card menu-admins" onclick="loadChannels()">
        <div class="icon-box">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        </div>
        <div>
          <h2 style="font-size: 1.3em; font-weight: 700;">Admins</h2>
          <p style="font-size: 0.85em; color: rgba(255,255,255,0.6);">Gestionar permisos y actividad</p>
        </div>
      </div>
    </div>
  </div>

  <div id="viewChannels" class="view-container">
    <div class="nav-header">
      <div class="btn-back" onclick="goBack()"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></div>
      <div><h1>Seleccionar Canal</h1><p>Tus canales vinculados</p></div>
    </div>
    <div id="channelListContainer">Cargando canales...</div>
  </div>

  <div id="viewAdmins" class="view-container">
    <div class="nav-header">
      <div class="btn-back" onclick="goBack()"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></div>
      <div><h1 id="lblChannelName">Canal</h1><p>Equipo administrativo</p></div>
    </div>
    <div id="adminListContainer">Cargando admins...</div>
  </div>

  <div id="viewDetail" class="view-container">
    <div class="nav-header">
      <div class="btn-back" onclick="goBack()"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></div>
      <div><h1 id="lblAdminName">Admin</h1><p>Permisos y Estad√≠sticas</p></div>
    </div>

    <div class="chart-wrapper">
      <div style="margin-bottom:10px; font-weight:600; color:#cbd5e1;">Actividad (7 D√≠as)</div>
      <div id="adminChart"></div>
    </div>

    <div style="margin-bottom:15px; font-weight:700;">Permisos de Telegram</div>
    <div class="perm-list" id="permContainer">
      </div>

    <button class="btn-save" onclick="savePermissions()">Guardar Cambios</button>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // 1. CONFIGURACI√ìN SUPABASE (PON TUS CREDENCIALES AQU√ç)
    const SUPABASE_URL = 'https://ndkupidhlauzroduvech.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_fSQ9uBUx_YTfxr2QL2-kfQ_pdE2cqHv'; // Tu clave p√∫blica
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Estado
    let historyStack = ['viewHome'];
    let currentAdmin = null; // Objeto admin seleccionado
    let currentChannelId = null;

    // --- NAVEGACI√ìN ---
    function navigateTo(viewId) {
      document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
      document.getElementById(viewId).classList.add('active');
      historyStack.push(viewId);
    }

    function goBack() {
      if(historyStack.length > 1) {
        historyStack.pop();
        const prev = historyStack[historyStack.length - 1];
        document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
        document.getElementById(prev).classList.add('active');
      }
    }

    // --- 1. CARGAR CANALES (REAL) ---
    async function loadChannels() {
      navigateTo('viewChannels');
      const container = document.getElementById('channelListContainer');
      
      const user = tg.initDataUnsafe?.user;
      const userId = user ? user.id : 1298554649; // Fallback para pruebas

      // Consulta real a tu tabla 'managed_channels'
      const { data: channels, error } = await supabase
        .from('managed_channels')
        .select('*')
        .eq('user_id', userId);

      if (error || !channels || channels.length === 0) {
        container.innerHTML = '<div style="color:red">No se encontraron canales.</div>';
        return;
      }

      container.innerHTML = '';
      channels.forEach(ch => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.onclick = () => loadAdmins(ch);
        div.innerHTML = `
          <div style="display:flex;align-items:center;gap:15px;">
            <div style="width:40px;height:40px;background:#1e293b;border-radius:12px;display:flex;justify-content:center;align-items:center;">üì¢</div>
            <div>
              <div style="font-weight:600">${ch.chat_title}</div>
              <div style="font-size:0.8em;color:#64748b">ID: ${ch.telegram_chat_id}</div>
            </div>
          </div>`;
        container.appendChild(div);
      });
    }

    // --- 2. CARGAR ADMINS (REAL) ---
    async function loadAdmins(channel) {
      currentChannelId = channel.telegram_chat_id;
      document.getElementById('lblChannelName').innerText = channel.chat_title;
      navigateTo('viewAdmins');
      
      const container = document.getElementById('adminListContainer');
      container.innerHTML = 'Cargando...';

      // Consulta a la nueva tabla 'channel_admins'
      const { data: admins, error } = await supabase
        .from('channel_admins')
        .select('*')
        .eq('channel_id', channel.telegram_chat_id);

      if (!admins || admins.length === 0) {
        container.innerHTML = '<div style="padding:20px; text-align:center; color:#666">No hay datos de admins sincronizados.<br>Ejecuta /sync en el bot.</div>';
        return;
      }

      container.innerHTML = '';
      admins.forEach(admin => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.onclick = () => openAdminDetail(admin);
        div.innerHTML = `
          <div style="display:flex;align-items:center;gap:15px;">
            <div style="width:40px;height:40px;border-radius:50%;background:#334155;display:flex;justify-content:center;align-items:center;font-weight:bold;">${(admin.first_name || 'U')[0]}</div>
            <div>
              <div style="font-weight:600">${admin.first_name || 'Usuario'}</div>
              <div style="font-size:0.8em;color:#64748b">${admin.role}</div>
            </div>
          </div>
          <span class="badge">${admin.status || 'Active'}</span>
        `;
        container.appendChild(div);
      });
    }

    // --- 3. DETALLES Y PERMISOS ---
    let chartInstance = null;

    function openAdminDetail(admin) {
      currentAdmin = admin; // Guardar referencia para actualizar
      document.getElementById('lblAdminName').innerText = admin.first_name || 'Admin';
      navigateTo('viewDetail');

      // A) Gr√°fica (Usando datos de la DB si existen, sino simulados visualmente)
      renderChart([admin.stats_posts || 0, admin.stats_views || 0, admin.stats_reactions || 0]);

      // B) Generar Checkboxes de Permisos Reales
      const permMap = [
        { key: 'can_change_info', label: 'Cambiar Info' },
        { key: 'can_post_messages', label: 'Publicar Mensajes' },
        { key: 'can_edit_messages', label: 'Editar Mensajes' },
        { key: 'can_delete_messages', label: 'Eliminar Mensajes' },
        { key: 'can_invite_users', label: 'Invitar Usuarios' },
        { key: 'can_restrict_members', label: 'Banear Usuarios' },
        { key: 'can_manage_voice_chats', label: 'Chats de Voz' }
      ];

      const container = document.getElementById('permContainer');
      container.innerHTML = '';

      permMap.forEach(p => {
        const isActive = admin[p.key] === true;
        const div = document.createElement('div');
        div.className = 'perm-item';
        div.onclick = () => togglePerm(div, p.key);
        div.innerHTML = `
          <div class="custom-check ${isActive ? 'checked' : ''}" id="chk_${p.key}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="20 6 9 17 4 12"/></svg>
          </div>
          <div>${p.label}</div>
        `;
        container.appendChild(div);
      });
    }

    // Toggle visual y en objeto temporal
    function togglePerm(element, key) {
      const check = element.querySelector('.custom-check');
      const isChecked = check.classList.contains('checked');
      
      if (isChecked) {
        check.classList.remove('checked');
        currentAdmin[key] = false;
      } else {
        check.classList.add('checked');
        currentAdmin[key] = true;
      }
      tg.HapticFeedback.selectionChanged();
    }

    // --- 4. GUARDAR EN SUPABASE ---
    async function savePermissions() {
      const btn = document.querySelector('.btn-save');
      btn.innerText = "Guardando...";
      
      // Actualizar en Supabase
      const { error } = await supabase
        .from('channel_admins')
        .update({
          can_change_info: currentAdmin.can_change_info,
          can_post_messages: currentAdmin.can_post_messages,
          can_edit_messages: currentAdmin.can_edit_messages,
          can_delete_messages: currentAdmin.can_delete_messages,
          can_invite_users: currentAdmin.can_invite_users,
          can_restrict_members: currentAdmin.can_restrict_members,
          can_manage_voice_chats: currentAdmin.can_manage_voice_chats
        })
        .eq('id', currentAdmin.id); // Usamos ID de la tabla, no user_id, para ser precisos

      if (error) {
        tg.showAlert("Error guardando: " + error.message);
        btn.innerText = "Error ‚ùå";
      } else {
        tg.HapticFeedback.notificationOccurred('success');
        btn.innerText = "¬°Guardado! ‚úÖ";
        
        // Opcional: Avisar al bot para aplicar cambios inmediatamente
        // tg.sendData(JSON.stringify({ type: 'update_perms', admin_id: currentAdmin.user_id }));
        
        setTimeout(() => { btn.innerText = "Guardar Cambios"; }, 2000);
      }
    }

    function renderChart(dataPoints) {
      if (chartInstance) chartInstance.destroy();
      
      // Si los datos son 0 (nuevos), ponemos fake para que se vea bonito
      const seriesData = dataPoints.reduce((a,b)=>a+b,0) === 0 ? [10, 40, 35, 50, 49, 60, 70] : dataPoints;

      const options = {
        series: [{ name: 'Actividad', data: seriesData }],
        chart: { type: 'area', height: 120, toolbar:{show:false}, background:'transparent' },
        colors: ['#3b82f6'],
        stroke: { curve: 'smooth', width: 2 },
        fill: { type: 'gradient', gradient: { shadeIntensity:1, opacityFrom:0.5, opacityTo:0.0 } },
        dataLabels: { enabled: false },
        grid: { show: false },
        xaxis: { labels: { show:false }, axisBorder:{show:false}, axisTicks:{show:false} },
        yaxis: { show: false },
        theme: { mode: 'dark' }
      };
      chartInstance = new ApexCharts(document.querySelector("#adminChart"), options);
      chartInstance.render();
    }
  </script>
</body>
</html>
