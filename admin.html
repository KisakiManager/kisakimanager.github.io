<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Kisaki Admin V5 - Secure</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <style>
    /* --- VARIABLES & RESET --- */
    :root {
      --bg-core: #020617;
      --card-bg: #0f172a;
      --text-main: #f8fafc;
      --text-sec: #94a3b8;
      --grad-ocean: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%);
      --grad-electric: linear-gradient(135deg, #2563eb 0%, #06b6d4 100%);
      --border-glass: rgba(255,255,255,0.08);
      --accent-blue: #3b82f6;
      --accent-green: #10b981;
      --accent-purple: #8b5cf6;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'SF Pro Display', 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }

    body {
      background-color: var(--bg-core);
      color: var(--text-main);
      min-height: 100vh;
      display: flex; flex-direction: column;
      overflow-x: hidden;
    }

    /* --- PANTALLA DE CARGA Y SEGURIDAD --- */
    #kisaki-loader {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: #020617;
      z-index: 99999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.5s ease;
    }

    /* Ocultar visualmente y permitir clics debajo */
    #kisaki-loader.hidden {
      opacity: 0;
      pointer-events: none;
    }

    /* Elementos dentro del loader */
    .loader-content { display: none; flex-direction: column; align-items: center; text-align: center; }
    .loader-content.active { display: flex; }

    .loader-logo-container { position: relative; width: 100px; height: 100px; margin-bottom: 25px; }
    
    .kisaki-cat {
      width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
      box-shadow: 0 0 25px rgba(59, 130, 246, 0.4);
      position: absolute; top: 10px; left: 10px; z-index: 2;
    }

    .loader-ring {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      border-radius: 50%; border: 3px solid transparent;
      border-top-color: #3b82f6; border-right-color: #8b5cf6;
      animation: spin 1.2s linear infinite; z-index: 1;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    .loader-text { font-size: 1.1em; color: #e2e8f0; font-weight: 500; letter-spacing: 0.5px; }
    
    /* Fase √âxito */
    .success-icon { font-size: 3.5em; margin-bottom: 15px; animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .typewriter { color: #4ade80; font-weight: 700; border-right: 2px solid #4ade80; padding-right: 4px; animation: blink 0.8s infinite; }
    @keyframes blink { 50% { border-color: transparent; } }

    /* Fase Bloqueo */
    .lock-icon { 
      width: 60px; height: 60px; background: rgba(239, 68, 68, 0.1); color: #ef4444; 
      border-radius: 18px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; 
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    .btn-telegram {
      margin-top: 25px; background: white; color: black; padding: 12px 24px; border-radius: 12px; 
      text-decoration: none; font-weight: 700; display: inline-flex; align-items: center; gap: 8px;
    }

    /* --- LAYOUT DE LA APP --- */
    .view-container { padding: 24px; display: none; animation: fadeScale 0.3s; position: relative; z-index: 10; }
    .view-container.active { display: block; }

    /* --- NAV --- */
    .nav-header { display: flex; align-items: center; gap: 15px; margin-bottom: 30px; }
    .btn-back {
      width: 40px; height: 40px; border-radius: 12px;
      background: rgba(255,255,255,0.05); border: 1px solid var(--border-glass);
      display: flex; align-items: center; justify-content: center; color: white; cursor: pointer;
    }

    /* --- MENU GRID --- */
    .menu-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
    .menu-card {
      background: var(--card-bg); border-radius: 24px; padding: 25px;
      border: 1px solid var(--border-glass); height: 160px; 
      display: flex; flex-direction: column; justify-content: flex-end; cursor: pointer;
      position: relative; overflow: hidden; transition: transform 0.1s;
    }
    .menu-card:active { transform: scale(0.98); }
    .menu-admins { background: var(--grad-ocean); }
    .menu-links { background: radial-gradient(circle at top right, #1e1b4b, #0f172a); }
    
    .icon-box {
      position: absolute; top: 20px; left: 20px; width: 50px; height: 50px; 
      background: rgba(255,255,255,0.1); border-radius: 16px; 
      display: flex; align-items: center; justify-content: center;
    }

    /* --- LISTAS --- */
    .list-item {
      background: linear-gradient(90deg, #0f172a 0%, #020617 100%);
      padding: 14px; border-radius: 18px; margin-bottom: 12px;
      display: flex; align-items: center; justify-content: space-between;
      border: 1px solid var(--border-glass);
    }
    .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7em; }
    .badge-blue { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .badge-purple { background: rgba(139, 92, 246, 0.2); color: #c084fc; }

    /* --- PERMISOS --- */
    .perm-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 30px; }
    .perm-item {
      display: flex; align-items: center; gap: 15px; padding: 12px;
      background: #0f0f0f; border-radius: 12px; cursor: pointer;
    }
    .custom-check {
      width: 22px; height: 22px; border: 2px solid #333; border-radius: 6px;
      display: flex; align-items: center; justify-content: center; transition: 0.2s;
    }
    .custom-check.checked { background: var(--accent-blue); border-color: var(--accent-blue); }
    .custom-check svg { display: none; width: 14px; stroke: white; stroke-width: 3; }
    .custom-check.checked svg { display: block; }

    .btn-save {
      width: 100%; background: var(--grad-electric); color: white; padding: 16px;
      border-radius: 16px; border: none; font-weight: 700; font-size: 1.1em;
      cursor: pointer; box-shadow: 0 4px 20px rgba(37, 99, 235, 0.4);
    }

    /* --- GR√ÅFICAS --- */
    .chart-wrapper { background: #0f172a; border-radius: 20px; padding: 15px; margin-bottom: 20px; border: 1px solid var(--border-glass); }
    
    /* --- METRICAS DE ENLACES --- */
    .metrics-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .metric-box {
      background: rgba(255,255,255,0.03); padding: 15px; border-radius: 16px;
      display: flex; flex-direction: column; gap: 5px; border: 1px solid var(--border-glass);
    }
    .mb-val { font-size: 1.2em; font-weight: 700; color:white; }
    .mb-lbl { font-size: 0.75em; color: var(--text-sec); }

    @keyframes fadeScale { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
  </style>
</head>
<body>

  <div id="kisaki-loader">
    
    <div id="phase-loading" class="loader-content active">
      <div class="loader-logo-container">
        <div class="loader-ring"></div>
        <img src="3538.png" alt="Kisaki" class="kisaki-cat"> 
      </div>
      <div class="loader-text">Cargando interfaz Kisaki...</div>
    </div>

    <div id="phase-success" class="loader-content">
      <div class="success-icon">üëç</div>
      <div class="loader-text typewriter">Acceso aprobado...</div>
    </div>

    <div id="phase-blocked" class="loader-content">
      <div class="lock-icon">
        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
      </div>
      <h2 style="color:white; font-size:1.4em; font-weight:700; margin-bottom:10px;">Acceso Restringido</h2>
      <p style="color:#94a3b8; font-size:0.9em; max-width:280px; text-align:center; line-height:1.5;">Esta herramienta administrativa solo funciona dentro del entorno seguro de Telegram.</p>
      <a href="https://t.me/KisakiManagerBot" class="btn-telegram">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
        Abrir Bot
      </a>
    </div>

  </div>

  <div id="viewHome" class="view-container active">
    <div style="margin: 20px 0 40px 0;">
      <h1 style="font-size: 2em; font-weight: 800;">Panel Kisaki</h1>
      <p style="color: var(--text-sec);">Gesti√≥n en tiempo real</p>
    </div>

    <div class="menu-grid">
      <div class="menu-card menu-admins" onclick="initFlow('admins')">
        <div class="icon-box">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        </div>
        <div>
          <h2 style="font-size: 1.3em; font-weight: 700;">Admins</h2>
          <p style="font-size: 0.85em; color: rgba(255,255,255,0.6);">Permisos y actividad</p>
        </div>
      </div>

      <div class="menu-card menu-links" onclick="initFlow('links')">
        <div class="icon-box">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
        </div>
        <div>
          <h2 style="font-size: 1.3em; font-weight: 700;">Enlaces</h2>
          <p style="font-size: 0.85em; color: rgba(255,255,255,0.6);">Tr√°fico y uniones</p>
        </div>
      </div>
    </div>
  </div>

  <div id="viewChannels" class="view-container">
    <div class="nav-header">
      <div class="btn-back" onclick="goBack()"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></div>
      <div><h1>Seleccionar Canal</h1><p id="contextLabel">...</p></div>
    </div>
    <div id="channelListContainer">Cargando canales...</div>
  </div>

  <div id="viewList" class="view-container">
    <div class="nav-header">
      <div class="btn-back" onclick="goBack()"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></div>
      <div><h1 id="listTitle">Lista</h1><p id="listSubtitle">Detalle del canal</p></div>
    </div>
    <div id="listContainer">Cargando datos...</div>
  </div>

  <div id="viewAdminDetail" class="view-container">
    <div class="nav-header">
      <div class="btn-back" onclick="goBack()"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></div>
      <div><h1 id="lblAdminName">Admin</h1><p>Gesti√≥n de permisos</p></div>
    </div>

    <div class="chart-wrapper">
      <div style="margin-bottom:10px; font-weight:600; color:#cbd5e1;">Actividad (7 D√≠as)</div>
      <div id="adminChart"></div>
    </div>

    <div style="margin-bottom:15px; font-weight:700;">Permisos Reales</div>
    <div class="perm-list" id="permContainer"></div>

    <button class="btn-save" onclick="savePermissions()">Guardar Cambios</button>
  </div>

  <div id="viewLinkDetail" class="view-container">
    <div class="nav-header">
      <div class="btn-back" onclick="goBack()"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></div>
      <div><h1 id="lblLinkName">Enlace</h1><p>Estad√≠sticas de tr√°fico</p></div>
    </div>

    <div class="metrics-row">
      <div class="metric-box">
        <span class="mb-val" style="color:var(--accent-green)" id="lnkJoins">0</span>
        <span class="mb-lbl">Uniones Totales</span>
      </div>
      <div class="metric-box">
        <span class="mb-val" style="color:var(--accent-purple)" id="lnkRate">0%</span>
        <span class="mb-lbl">Tasa Aprobaci√≥n</span>
      </div>
    </div>

    <div class="chart-wrapper">
      <div style="margin-bottom:10px; font-weight:600; color:#cbd5e1;">Flujo de Usuarios</div>
      <div id="linkChart"></div>
    </div>
  </div>

  <script>
    // --- 1. SCRIPT DE SEGURIDAD (EJECUCI√ìN INMEDIATA) ---
    (function() {
      const tg = window.Telegram.WebApp;
      const loader = document.getElementById('kisaki-loader');
      const pLoad = document.getElementById('phase-loading');
      const pSuccess = document.getElementById('phase-success');
      const pBlocked = document.getElementById('phase-blocked');

      // 1. Verificar si estamos en Telegram (initData debe existir y no estar vac√≠o)
      const isTelegram = (tg.initData && tg.initData.length > 0);
      
      // 2. ¬øYa entramos antes en esta sesi√≥n? (Para no mostrar el gato cada vez)
      const isSessionActive = sessionStorage.getItem('kisaki_admin_session');

      if (!isTelegram) {
        // --- CASO A: BLOQUEADO (Navegador Externo) ---
        pLoad.classList.remove('active');
        pBlocked.classList.add('active');
        // El loader se queda visible bloqueando todo.
      
      } else {
        // --- CASO B: ACCESO PERMITIDO (Telegram) ---
        tg.expand(); // Expandir pantalla completa

        if (isSessionActive) {
          // B1: Usuario recurrente -> Entrar directo sin animaci√≥n
          loader.classList.add('hidden');
          setTimeout(() => { loader.style.display = 'none'; }, 500);
        } else {
          // B2: Primera vez -> Mostrar animaci√≥n del gato
          setTimeout(() => {
            // Cambiar a fase "√âxito"
            pLoad.classList.remove('active');
            pSuccess.classList.add('active');
            
            // Vibraci√≥n t√°ctil si es posible
            if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            
            // Guardar sesi√≥n
            sessionStorage.setItem('kisaki_admin_session', 'true');

            // Ocultar loader despu√©s de 1.5s
            setTimeout(() => {
              loader.classList.add('hidden');
              setTimeout(() => { loader.style.display = 'none'; }, 500);
            }, 1500);
          }, 2000); // 2 segundos de "carga" para ver la animaci√≥n
        }
      }
    })();

    // --- 2. L√ìGICA DEL ADMIN PANEL (SUPABASE) ---
    
    // Credenciales
    const SUPABASE_URL = 'https://ndkupidhlauzroduvech.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_fSQ9uBUx_YTfxr2QL2-kfQ_pdE2cqHv';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Estado Global
    let historyStack = ['viewHome'];
    let currentFlow = ''; 
    let currentChannel = null;
    let currentItem = null; 
    let chartInstance = null;

    // Navegaci√≥n
    function navigateTo(viewId) {
      document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
      document.getElementById(viewId).classList.add('active');
      historyStack.push(viewId);
    }

    function goBack() {
      if(historyStack.length > 1) {
        historyStack.pop();
        const prev = historyStack[historyStack.length - 1];
        document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
        document.getElementById(prev).classList.add('active');
      }
    }

    // Funciones de Negocio
    function initFlow(flowType) {
      currentFlow = flowType;
      document.getElementById('contextLabel').innerText = flowType === 'admins' ? 'Gestionar Equipo' : 'Ver Enlaces';
      loadChannels();
    }

    async function loadChannels() {
      navigateTo('viewChannels');
      const container = document.getElementById('channelListContainer');
      container.innerHTML = 'Cargando...';

      const user = window.Telegram.WebApp.initDataUnsafe?.user;
      const userId = user ? user.id : 1298554649; // Fallback

      try {
        const { data: channels, error } = await supabase
          .from('managed_channels')
          .select('*')
          .eq('user_id', userId);

        if (error) throw error;

        if (!channels || channels.length === 0) {
          container.innerHTML = '<div style="color:#ef4444; text-align:center; padding:20px;">No se encontraron canales.<br>A√±ade el bot como admin.</div>';
          return;
        }

        container.innerHTML = '';
        channels.forEach(ch => {
          const div = document.createElement('div');
          div.className = 'list-item';
          div.onclick = () => loadItems(ch);
          div.innerHTML = `
            <div style="display:flex;align-items:center;gap:15px;">
              <div style="width:40px;height:40px;background:#1e293b;border-radius:12px;display:flex;justify-content:center;align-items:center;">üì¢</div>
              <div>
                <div style="font-weight:600">${ch.chat_title}</div>
                <div style="font-size:0.8em;color:#64748b">ID: ${ch.telegram_chat_id}</div>
              </div>
            </div>`;
          container.appendChild(div);
        });
      } catch (err) {
        console.error(err);
        container.innerHTML = `<div style="color:red">Error: ${err.message}</div>`;
      }
    }

    async function loadItems(channel) {
      currentChannel = channel;
      document.getElementById('listTitle').innerText = currentFlow === 'admins' ? 'Admins' : 'Enlaces';
      document.getElementById('listSubtitle').innerText = channel.chat_title;
      navigateTo('viewList');

      const container = document.getElementById('listContainer');
      container.innerHTML = 'Cargando...';

      let tableName = currentFlow === 'admins' ? 'channel_admins' : 'invite_links';

      const { data: items, error } = await supabase
        .from(tableName)
        .select('*')
        .eq('channel_id', channel.telegram_chat_id);

      if (!items || items.length === 0) {
        container.innerHTML = `<div style="text-align:center;color:#666;padding:20px;">No hay datos registrados.<br>Ejecuta /sync en el bot.</div>`;
        return;
      }

      container.innerHTML = '';
      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'list-item';

        if (currentFlow === 'admins') {
          div.onclick = () => openAdminDetail(item);
          div.innerHTML = `
            <div style="display:flex;align-items:center;gap:15px;">
              <div style="width:40px;height:40px;border-radius:50%;background:#334155;display:flex;justify-content:center;align-items:center;">${(item.first_name||'U')[0]}</div>
              <div><div style="font-weight:600">${item.first_name || 'Usuario'}</div><div style="font-size:0.8em;color:#64748b">${item.role || 'Admin'}</div></div>
            </div>
            <span class="badge badge-blue">Editar</span>
          `;
        } else {
          div.onclick = () => openLinkDetail(item);
          div.innerHTML = `
            <div style="display:flex;align-items:center;gap:15px;">
              <div style="width:40px;height:40px;border-radius:12px;background:rgba(139,92,246,0.2);color:#c084fc;display:flex;justify-content:center;align-items:center;">üîó</div>
              <div><div style="font-weight:600">${item.name || 'Enlace'}</div><div style="font-size:0.8em;color:#64748b">Por: ${item.creator_name || '?'}</div></div>
            </div>
            <span class="badge badge-purple">${item.joins || 0} Joins</span>
          `;
        }
        container.appendChild(div);
      });
    }

    function openAdminDetail(admin) {
      currentItem = admin;
      document.getElementById('lblAdminName').innerText = admin.first_name;
      navigateTo('viewAdminDetail');
      renderChart("#adminChart", [admin.stats_posts||0, admin.stats_views||0, admin.stats_reactions||0, 10, 20, 15, 30], '#3b82f6');

      const permMap = [
        { key: 'can_change_info', label: 'Cambiar Info' },
        { key: 'can_post_messages', label: 'Publicar' },
        { key: 'can_edit_messages', label: 'Editar' },
        { key: 'can_delete_messages', label: 'Eliminar' },
        { key: 'can_invite_users', label: 'Invitar' },
        { key: 'can_restrict_members', label: 'Banear' }
      ];

      const container = document.getElementById('permContainer');
      container.innerHTML = '';
      permMap.forEach(p => {
        const isActive = admin[p.key] === true;
        const div = document.createElement('div');
        div.className = 'perm-item';
        div.onclick = () => togglePerm(div, p.key);
        div.innerHTML = `<div class="custom-check ${isActive?'checked':''}"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="20 6 9 17 4 12"/></svg></div><div>${p.label}</div>`;
        container.appendChild(div);
      });
    }

    function openLinkDetail(link) {
      document.getElementById('lblLinkName').innerText = link.name || 'Enlace';
      document.getElementById('lnkJoins').innerText = link.joins || 0;
      document.getElementById('lnkRate').innerText = link.rate || '100%';
      navigateTo('viewLinkDetail');
      let j = link.joins || 0;
      renderChart("#linkChart", [j, j+2, j+5, j+10, j+12, j+20, j+35], '#10b981');
    }

    function togglePerm(el, key) {
      const chk = el.querySelector('.custom-check');
      if(chk.classList.contains('checked')) {
        chk.classList.remove('checked');
        currentItem[key] = false;
      } else {
        chk.classList.add('checked');
        currentItem[key] = true;
      }
      if(window.Telegram.WebApp.HapticFeedback) window.Telegram.WebApp.HapticFeedback.selectionChanged();
    }

    async function savePermissions() {
      const btn = document.querySelector('.btn-save');
      btn.innerText = "Guardando...";
      const { error } = await supabase
        .from('channel_admins')
        .update({
          can_change_info: currentItem.can_change_info,
          can_post_messages: currentItem.can_post_messages,
          can_edit_messages: currentItem.can_edit_messages,
          can_delete_messages: currentItem.can_delete_messages,
          can_invite_users: currentItem.can_invite_users,
          can_restrict_members: currentItem.can_restrict_members
        })
        .eq('id', currentItem.id);

      if (error) {
        window.Telegram.WebApp.showAlert("Error: " + error.message);
        btn.innerText = "Error ‚ùå";
      } else {
        if(window.Telegram.WebApp.HapticFeedback) window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        btn.innerText = "Guardado ‚úÖ";
        setTimeout(() => btn.innerText = "Guardar Cambios", 2000);
      }
    }

    function renderChart(selector, data, color) {
      if(chartInstance) chartInstance.destroy();
      const options = {
        series: [{ name: 'Data', data: data }],
        chart: { type: 'area', height: 120, toolbar:{show:false}, background:'transparent' },
        colors: [color],
        stroke: { curve: 'smooth', width: 2 },
        fill: { type: 'gradient', gradient: { shadeIntensity:1, opacityFrom:0.5, opacityTo:0.0 } },
        dataLabels: { enabled: false },
        grid: { show: false },
        xaxis: { labels: { show:false }, axisBorder:{show:false}, axisTicks:{show:false} },
        yaxis: { show: false },
        theme: { mode: 'dark' }
      };
      chartInstance = new ApexCharts(document.querySelector(selector), options);
      chartInstance.render();
    }
  </script>
</body>
</html>
