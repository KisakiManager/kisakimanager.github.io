<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Kisaki Admin V5 - Secure</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

 <script>
/* ================================
   KISAKI ADMIN PANEL HARDENED
================================ */

// --------- TELEGRAM SECURITY LAYER ----------
(function () {
  const tg = window.Telegram?.WebApp;
  const lockScreen = document.getElementById("security-lock");

  if (!tg || !tg.initData) {
    console.warn("Telegram API no disponible");
    return;
  }

  const isTelegram = tg.initData.length > 0;

  if (!isTelegram) {
    console.warn("Acceso externo bloqueado");
    lockScreen.style.display = "flex";
    return;
  }

  tg.expand();
  lockScreen.style.display = "none";
})();

// --------- SUPABASE ----------
const SUPABASE_URL = "https://ndkupidhlauzroduvech.supabase.co";
const SUPABASE_KEY = "sb_publishable_fSQ9uBUx_YTfxr2QL2-kfQ_pdE2cqHv";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// --------- GLOBAL STATE ----------
let historyStack = ["viewHome"];
let currentFlow = "";
let currentChannel = null;
let currentItem = null;
let tempPermissions = {};

let adminChartInstance = null;
let linkChartInstance = null;

// --------- HELPERS ----------
function safeText(text) {
  if (!text) return "";
  return text.toString().replace(/[<>]/g, "");
}

function tgSafe(fn) {
  try {
    if (window.Telegram?.WebApp) fn();
  } catch (e) {
    console.warn("Telegram API error", e);
  }
}

// --------- NAVIGATION ----------
function navigateTo(viewId) {
  document.querySelectorAll(".view-container").forEach(v => v.classList.remove("active"));
  document.getElementById(viewId).classList.add("active");
  historyStack.push(viewId);
}

function goBack() {
  if (historyStack.length > 1) {
    historyStack.pop();
    const prev = historyStack[historyStack.length - 1];
    document.querySelectorAll(".view-container").forEach(v => v.classList.remove("active"));
    document.getElementById(prev).classList.add("active");
  }
}

// --------- FLOW ----------
function initFlow(flow) {
  currentFlow = flow;
  historyStack = ["viewHome"]; // reset stack limpio

  document.getElementById("contextLabel").innerText =
    flow === "admins" ? "Gestionar Equipo" : "Ver Enlaces";

  loadChannels();
}

// --------- LOAD CHANNELS ----------
async function loadChannels() {
  navigateTo("viewChannels");

  const container = document.getElementById("channelListContainer");
  container.innerText = "Cargando...";

  const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;

  if (!tgUser) {
    container.innerHTML = "<div style='color:red'>SesiÃ³n Telegram invÃ¡lida</div>";
    return;
  }

  try {
    const { data, error } = await supabase
      .from("managed_channels")
      .select("*")
      .eq("user_id", tgUser.id);

    if (error) throw error;

    if (!data || data.length === 0) {
      container.innerHTML =
        "<div style='color:#ef4444;text-align:center;padding:20px'>No hay canales vinculados</div>";
      return;
    }

    container.innerHTML = "";

    data.forEach(ch => {
      const div = document.createElement("div");
      div.className = "list-item";
      div.onclick = () => loadItems(ch);

      div.innerHTML = `
        <div style="display:flex;gap:12px;align-items:center">
          <div style="width:40px;height:40px;background:#1e293b;border-radius:12px;display:flex;align-items:center;justify-content:center">ðŸ“¢</div>
          <div>
            <div style="font-weight:600">${safeText(ch.chat_title)}</div>
            <div style="font-size:.8em;color:#64748b">ID: ${ch.telegram_chat_id}</div>
          </div>
        </div>`;

      container.appendChild(div);
    });
  } catch (err) {
    console.error(err);
    container.innerHTML = `<div style="color:red">Error DB: ${err.message}</div>`;
  }
}

// --------- LOAD ITEMS ----------
async function loadItems(channel) {
  currentChannel = channel;

  document.getElementById("listTitle").innerText =
    currentFlow === "admins" ? "Admins" : "Enlaces";

  document.getElementById("listSubtitle").innerText = safeText(channel.chat_title);

  navigateTo("viewList");

  const container = document.getElementById("listContainer");
  container.innerText = "Cargando...";

  const table = currentFlow === "admins" ? "channel_admins" : "invite_links";

  try {
    const { data, error } = await supabase
      .from(table)
      .select("*")
      .eq("channel_id", channel.telegram_chat_id);

    if (error) throw error;

    if (!data || data.length === 0) {
      container.innerHTML =
        "<div style='text-align:center;color:#666;padding:20px'>Sin datos sincronizados</div>";
      return;
    }

    container.innerHTML = "";

    data.forEach(item => {
      const div = document.createElement("div");
      div.className = "list-item";

      if (currentFlow === "admins") {
        div.onclick = () => openAdminDetail(item);
        div.innerHTML = `
          <div style="display:flex;gap:12px;align-items:center">
            <div style="width:40px;height:40px;background:#334155;border-radius:50%;display:flex;align-items:center;justify-content:center">
              ${(item.first_name || "U")[0]}
            </div>
            <div>
              <div style="font-weight:600">${safeText(item.first_name)}</div>
              <div style="font-size:.8em;color:#64748b">${safeText(item.role || "Admin")}</div>
            </div>
          </div>
          <span class="badge badge-blue">Editar</span>
        `;
      } else {
        div.onclick = () => openLinkDetail(item);
        div.innerHTML = `
          <div style="display:flex;gap:12px;align-items:center">
            <div style="width:40px;height:40px;background:rgba(139,92,246,.2);border-radius:12px;display:flex;align-items:center;justify-content:center">ðŸ”—</div>
            <div>
              <div style="font-weight:600">${safeText(item.name)}</div>
              <div style="font-size:.8em;color:#64748b">Por: ${safeText(item.creator_name)}</div>
            </div>
          </div>
          <span class="badge badge-purple">${item.joins || 0} Joins</span>
        `;
      }

      container.appendChild(div);
    });
  } catch (err) {
    console.error(err);
    container.innerHTML = `<div style="color:red">Error DB: ${err.message}</div>`;
  }
}

// --------- ADMIN DETAIL ----------
function openAdminDetail(admin) {
  currentItem = admin;
  tempPermissions = { ...admin };

  document.getElementById("lblAdminName").innerText = safeText(admin.first_name);

  navigateTo("viewAdminDetail");

  renderAdminChart([5, 8, 12, 6, 9, 15, 20]);

  const perms = [
    ["can_change_info", "Cambiar Info"],
    ["can_post_messages", "Publicar"],
    ["can_edit_messages", "Editar"],
    ["can_delete_messages", "Eliminar"],
    ["can_invite_users", "Invitar"],
    ["can_restrict_members", "Banear"]
  ];

  const container = document.getElementById("permContainer");
  container.innerHTML = "";

  perms.forEach(p => {
    const active = admin[p[0]] === true;

    const div = document.createElement("div");
    div.className = "perm-item";
    div.onclick = () => togglePerm(div, p[0]);

    div.innerHTML = `
      <div class="custom-check ${active ? "checked" : ""}">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
      </div>
      <div>${p[1]}</div>
    `;

    container.appendChild(div);
  });
}

// --------- LINK DETAIL ----------
function openLinkDetail(link) {
  document.getElementById("lblLinkName").innerText = safeText(link.name);
  document.getElementById("lnkJoins").innerText = link.joins || 0;
  document.getElementById("lnkRate").innerText = link.rate || "100%";

  navigateTo("viewLinkDetail");

  renderLinkChart([2, 6, 12, 18, 22, 30, 40]);
}

// --------- PERMISSIONS ----------
function togglePerm(el, key) {
  const chk = el.querySelector(".custom-check");

  chk.classList.toggle("checked");
  tempPermissions[key] = chk.classList.contains("checked");

  tgSafe(() => Telegram.WebApp.HapticFeedback.selectionChanged());
}

// --------- SAVE ----------
async function savePermissions() {
  const btn = document.querySelector(".btn-save");
  btn.innerText = "Guardando...";

  try {
    const { error } = await supabase
      .from("channel_admins")
      .update(tempPermissions)
      .eq("id", currentItem.id);

    if (error) throw error;

    currentItem = { ...tempPermissions };

    tgSafe(() =>
      Telegram.WebApp.HapticFeedback.notificationOccurred("success")
    );

    btn.innerText = "Guardado âœ…";
    setTimeout(() => (btn.innerText = "Guardar Cambios"), 1500);
  } catch (err) {
    console.error(err);
    btn.innerText = "Error âŒ";
    tgSafe(() => Telegram.WebApp.showAlert(err.message));
  }
}

// --------- CHARTS ----------
function renderAdminChart(data) {
  if (adminChartInstance) adminChartInstance.destroy();

  adminChartInstance = new ApexCharts(
    document.querySelector("#adminChart"),
    chartConfig(data, "#3b82f6")
  );

  adminChartInstance.render();
}

function renderLinkChart(data) {
  if (linkChartInstance) linkChartInstance.destroy();

  linkChartInstance = new ApexCharts(
    document.querySelector("#linkChart"),
    chartConfig(data, "#10b981")
  );

  linkChartInstance.render();
}

function chartConfig(data, color) {
  return {
    series: [{ data }],
    chart: { type: "area", height: 120, toolbar: { show: false } },
    colors: [color],
    stroke: { curve: "smooth", width: 2 },
    fill: { type: "gradient", gradient: { opacityFrom: 0.4, opacityTo: 0 } },
    dataLabels: { enabled: false },
    grid: { show: false },
    xaxis: { labels: { show: false } },
    yaxis: { show: false },
    theme: { mode: "dark" }
  };
}
</script>