<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Kisaki Bot Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body { background-color: #0f172a; color: #e2e8f0; padding-bottom: 80px; }

    /* Header */
    .page-header { padding: 20px; background: #1e293b; border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; }

    /* BOT LIST (RACK STYLE) */
    .bot-rack { padding: 0 15px; display: flex; flex-direction: column; gap: 15px; }

    .bot-unit {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 15px;
      display: flex; justify-content: space-between; align-items: center;
      position: relative; overflow: hidden;
      transition: all 0.2s ease;
      /* Cursor de mano para indicar que es clickeable */
      cursor: pointer; 
    }
    
    .bot-unit:active {
        background-color: #334155;
    }

    /* Indicador de estado (Luz led) */
    .status-led { width: 10px; height: 10px; border-radius: 50%; display: inline-block; box-shadow: 0 0 10px currentColor; margin-right: 8px; }
    .led-active { color: #4ade80; background: #4ade80; }
    .led-paused { color: #facc15; background: #facc15; }
    .led-error { color: #ef4444; background: #ef4444; }

    .bot-info h3 { margin: 0; font-size: 1em; color: white; display: flex; align-items: center; }
    .bot-info span { font-size: 0.8em; color: #94a3b8; font-family: monospace; }

    /* Botones de Acción */
    .bot-actions { display: flex; gap: 10px; }
    .btn-icon { background: rgba(255,255,255,0.05); border: none; color: #cbd5e1; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .btn-icon:hover { background: rgba(255,255,255,0.1); color: white; }
    .btn-delete { color: #f87171; }

    /* FAB (Botón Flotante para Añadir) */
    .fab-add {
      position: fixed; bottom: 20px; right: 20px;
      width: 56px; height: 56px;
      background: #6366f1; color: white;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
      cursor: pointer; z-index: 50;
    }

    /* MODAL */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); z-index: 100;
      display: none; align-items: center; justify-content: center;
      backdrop-filter: blur(5px);
    }
    .modal-card {
      background: #1e293b; width: 90%; max-width: 400px;
      border-radius: 16px; padding: 25px;
      border: 1px solid #475569;
    }
    .input-group { margin-bottom: 20px; }
    .input-field {
      width: 100%; background: #0f172a; border: 1px solid #334155;
      color: white; padding: 12px; border-radius: 8px; font-family: monospace;
      outline: none; box-sizing: border-box; /* Fix CSS box model */
    }
    .btn-primary { width: 100%; background: #6366f1; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; }

  </style>
</head>
<body>

  <div class="page-header">
    <a href="index.html" style="color:#94a3b8; text-decoration:none; display:flex; align-items:center; gap:8px; font-size:0.9em; margin-bottom:5px;">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg> Inicio
    </a>
    <h1 style="margin:0; font-size:1.6em;">Gestión de Bots</h1>
    <span style="color: #64748b; font-size: 0.9em;">Panel de Control de Clones</span>
  </div>

  <div class="bot-rack" id="botContainer">
    <div style="text-align:center; padding:40px; color:#64748b;">
      <div class="loading-spinner" style="margin: 0 auto 10px auto;"></div>
      Cargando bots...
    </div>
  </div>

  <div class="fab-add" onclick="openModal()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
  </div>

  <div class="modal-overlay" id="addBotModal">
    <div class="modal-card">
      <h2 style="margin-top:0;">Nuevo Clon</h2>
      <p style="color:#94a3b8; font-size:0.9em; margin-bottom:20px;">
        Pega el Token del bot obtenido en <a href="#" style="color:#6366f1;">@BotFather</a>.
      </p>

      <div class="input-group">
        <label style="font-size:0.8em; color:#cbd5e1; display:block; margin-bottom:5px;">Bot Token</label>
        <input type="text" id="botTokenInput" class="input-field" placeholder="123456:ABC-Def...">
      </div>

      <div class="input-group">
        <label style="font-size:0.8em; color:#cbd5e1; display:block; margin-bottom:5px;">Nombre (Etiqueta)</label>
        <input type="text" id="botNameInput" class="input-field" placeholder="@MiNuevoBot">
      </div>

      <div style="display:flex; gap:10px;">
        <button class="btn-primary" onclick="saveBot()" id="btnSave">Conectar</button>
        <button class="btn-primary" onclick="closeModal()" style="background:transparent; border:1px solid #475569;">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    const user = tg.initDataUnsafe?.user;

    // CONEXIÓN SUPABASE
    const SUPABASE_URL = 'https://ndkupidhlauzroduvech.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_fSQ9uBUx_YTfxr2QL2-kfQ_pdE2cqHv'; 
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Identificar al dueño (usamos ID de Telegram)
    const OWNER_ID = user ? user.id : 1298554649; // Fallback para pruebas en PC

    // 1. CARGAR BOTS
    async function loadBots() {
      const container = document.getElementById('botContainer');

      const { data, error } = await supabase
        .from('bots')
        .select('*')
        .eq('owner_id', OWNER_ID)
        .order('created_at', { ascending: false });

      if (error) {
        container.innerHTML = `<p style="color:#ef4444; text-align:center;">Error cargando bots: ${error.message}</p>`;
        return;
      }

      if (!data || data.length === 0) {
        container.innerHTML = `
          <div style="text-align:center; padding:40px; border:2px dashed #334155; border-radius:12px;">
            <p style="color:#94a3b8;">No tienes bots conectados.</p>
            <p style="font-size:0.8em; color:#64748b;">Pulsa + para añadir uno.</p>
          </div>`;
        return;
      }

      container.innerHTML = '';
      data.forEach(bot => {
        const ledClass = bot.status === 'active' ? 'led-active' : 'led-paused';
        
        // MODIFICACIÓN: Enlace al panel de configuración (bot_settings.html)
        // Se añade onclick al contenedor y stopPropagation a los botones para evitar conflicto
        container.innerHTML += `
          <div class="bot-unit" onclick="window.location.href='bot_settings.html?id=${bot.id}'">
            <div class="bot-info">
              <h3><span class="status-led ${ledClass}"></span> ${bot.bot_username || 'Sin Nombre'}</h3>
              <span>Token: ...${bot.bot_token.substr(-5)}</span>
            </div>
            
            <div class="bot-actions" onclick="event.stopPropagation()">
              <button class="btn-icon" onclick="toggleBot('${bot.id}', '${bot.status}')">
                ${bot.status === 'active' 
                  ? '<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>' 
                  : '<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>'}
              </button>
              <button class="btn-icon btn-delete" onclick="deleteBot('${bot.id}')">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
              </button>
            </div>
          </div>
        `;
      });
    }

    // 2. GUARDAR NUEVO BOT
    async function saveBot() {
      const token = document.getElementById('botTokenInput').value.trim();
      const name = document.getElementById('botNameInput').value.trim();
      const btn = document.getElementById('btnSave');

      if (!token) return alert("El token es obligatorio");

      btn.innerText = "Conectando...";
      btn.disabled = true;

      // Insertar en Supabase
      const { error } = await supabase.from('bots').insert({
        owner_id: OWNER_ID,
        bot_token: token,
        bot_username: name,
        status: 'active',
        modules_config: { welcome: true, moderation: false } // Config base
      });

      if (error) {
        alert("Error: " + error.message);
        btn.innerText = "Conectar";
        btn.disabled = false;
      } else {
        closeModal();
        loadBots();
        alert("✅ Bot añadido exitosamente. Se activará en el próximo ciclo.");
        // Limpiar inputs
        document.getElementById('botTokenInput').value = "";
        document.getElementById('botNameInput').value = "";
        btn.innerText = "Conectar";
        btn.disabled = false;
      }
    }

    // 3. CAMBIAR ESTADO (PAUSA/PLAY)
    async function toggleBot(id, currentStatus) {
      const newStatus = currentStatus === 'active' ? 'paused' : 'active';
      await supabase.from('bots').update({ status: newStatus }).eq('id', id);
      loadBots(); // Recargar UI
    }

    // 4. ELIMINAR BOT
    async function deleteBot(id) {
      if(!confirm("¿Seguro que quieres eliminar este bot? Dejará de responder.")) return;
      await supabase.from('bots').delete().eq('id', id);
      loadBots();
    }

    // UI Helpers
    function openModal() { document.getElementById('addBotModal').style.display = 'flex'; }
    function closeModal() { document.getElementById('addBotModal').style.display = 'none'; }

    // Init
    loadBots();
  </script>
</body>
</html>
