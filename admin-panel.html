<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Admin Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    /* Estilos base iguales a index */
    :root { --bg:#020617; --glass:rgba(15,23,42,0.8); --border:rgba(255,255,255,0.1); --blue:#3b82f6; }
    body { background:var(--bg); color:#f8fafc; font-family:'Inter', sans-serif; padding:20px; }
    
    /* Headers & Nav */
    .nav { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .btn-icon { width:40px; height:40px; border-radius:12px; background:rgba(255,255,255,0.05); display:flex; align-items:center; justify-content:center; color:white; border:none; cursor:pointer; }
    
    /* Lists */
    .list { display:flex; flex-direction:column; gap:10px; }
    .item { background:var(--glass); border:1px solid var(--border); padding:15px; border-radius:16px; display:flex; align-items:center; gap:15px; cursor:pointer; }
    .avatar { width:40px; height:40px; border-radius:50%; background:#1e293b; display:flex; align-items:center; justify-content:center; font-weight:bold; }
    
    /* Permissions */
    .perm-toggle { display:flex; justify-content:space-between; padding:12px; background:#0f172a; border-radius:12px; margin-bottom:8px; }
    .switch { position:relative; display:inline-block; width:40px; height:24px; }
    .switch input { opacity:0; width:0; height:0; }
    .slider { position:absolute; inset:0; background:#334155; border-radius:24px; transition:.4s; }
    .slider:before { position:absolute; content:""; height:18px; width:18px; left:3px; bottom:3px; background:white; border-radius:50%; transition:.4s; }
    input:checked + .slider { background:var(--blue); }
    input:checked + .slider:before { transform: translateX(16px); }

    /* Chart Box */
    .chart-box { background:var(--glass); border:1px solid var(--border); border-radius:20px; padding:15px; margin-top:20px; }
  </style>
</head>
<body>

  <div id="viewChannels">
    <div class="nav">
      <a href="admin.html" class="btn-icon">‚Üê</a>
      <h2>Canales</h2>
      <div style="width:40px"></div>
    </div>
    <div class="list" id="channelList">Cargando...</div>
  </div>

  <div id="viewAdmins" style="display:none;">
    <div class="nav">
      <button class="btn-icon" onclick="switchView('viewChannels')">‚Üê</button>
      <h2 id="lblChannel">Admins</h2>
      <div style="width:40px"></div>
    </div>
    
    <div class="chart-box">
      <h4 style="margin-bottom:10px; color:#94a3b8;">Top Actividad (Posts)</h4>
      <div id="compareChart"></div>
    </div>
    
    <h4 style="margin:20px 0 10px; color:#94a3b8;">Equipo</h4>
    <div class="list" id="adminList"></div>
  </div>

  <div id="viewEdit" style="display:none;">
    <div class="nav">
      <button class="btn-icon" onclick="switchView('viewAdmins')">‚Üê</button>
      <h2 id="lblAdmin">Editar</h2>
      <button class="btn-icon" style="color:#ef4444;" onclick="alert('Funci√≥n Demote')">üóë</button>
    </div>

    <div class="list" id="permContainer">
      </div>
    
    <button onclick="savePerms()" style="width:100%; margin-top:20px; padding:15px; background:var(--blue); border:none; border-radius:16px; color:white; font-weight:bold; font-size:1em;">Guardar Cambios</button>
  </div>

  <script>
    // Configura TU Supabase aqu√≠
    const sbUrl = 'https://ndkupidhlauzroduvech.supabase.co';
    const sbKey = 'sb_publishable_fSQ9uBUx_YTfxr2QL2-kfQ_pdE2cqHv';
    const supabase = window.supabase.createClient(sbUrl, sbKey);
    const tg = window.Telegram.WebApp;
    tg.expand();

    let currentAdmin = null;

    // 1. Cargar Canales
    async function loadChannels() {
      const { data } = await supabase.from('managed_channels').select('*'); // Filtra por user_id en prod
      const list = document.getElementById('channelList');
      list.innerHTML = '';
      data.forEach(c => {
        list.innerHTML += `<div class="item" onclick="loadAdmins(${c.telegram_chat_id}, '${c.chat_title}')">
          <div class="avatar">üì¢</div> <b>${c.chat_title}</b>
        </div>`;
      });
    }

    // 2. Cargar Admins y Gr√°fica
    async function loadAdmins(chatId, title) {
      switchView('viewAdmins');
      document.getElementById('lblChannel').innerText = title;
      const { data: admins } = await supabase.from('channel_admins').select('*').eq('channel_id', chatId);
      
      // Render Lista
      const list = document.getElementById('adminList');
      list.innerHTML = '';
      admins.forEach(a => {
        list.innerHTML += `<div class="item" onclick='editAdmin(${JSON.stringify(a)})'>
          <div class="avatar">${a.first_name[0]}</div>
          <div style="flex:1"><b>${a.first_name}</b><br><small style="color:#94a3b8">${a.role}</small></div>
          <div>‚úèÔ∏è</div>
        </div>`;
      });

      // Render Gr√°fica Comparativa
      const names = admins.map(a => a.first_name);
      const posts = admins.map(a => a.stats_posts || 0);
      
      new ApexCharts(document.querySelector("#compareChart"), {
        series: [{ name: 'Posts', data: posts }],
        chart: { type: 'bar', height: 200, toolbar:{show:false}, background:'transparent' },
        colors: ['#3b82f6'],
        plotOptions: { bar: { borderRadius: 4, horizontal: true } },
        dataLabels: { enabled: false },
        xaxis: { categories: names, labels:{style:{colors:'#94a3b8'}} },
        yaxis: { labels:{style:{colors:'white'}} },
        theme: { mode: 'dark' },
        grid: { borderColor: '#334155' }
      }).render();
    }

    // 3. Editar Permisos
    function editAdmin(admin) {
      currentAdmin = admin;
      switchView('viewEdit');
      document.getElementById('lblAdmin').innerText = admin.first_name;
      
      const perms = [
        {k:'can_post_messages', l:'Publicar Mensajes'},
        {k:'can_edit_messages', l:'Editar Mensajes'},
        {k:'can_delete_messages', l:'Borrar Mensajes'},
        {k:'can_restrict_members', l:'Banear Usuarios'},
        {k:'can_invite_users', l:'A√±adir Usuarios'}
      ];

      const cont = document.getElementById('permContainer');
      cont.innerHTML = '';
      perms.forEach(p => {
        const checked = admin[p.k] ? 'checked' : '';
        cont.innerHTML += `
          <label class="perm-toggle">
            <span>${p.l}</span>
            <div class="switch"><input type="checkbox" id="${p.k}" ${checked}><span class="slider"></span></div>
          </label>`;
      });
    }

    async function savePerms() {
      // Recoger valores
      const updates = {};
      ['can_post_messages','can_edit_messages','can_delete_messages','can_restrict_members','can_invite_users'].forEach(k => {
        updates[k] = document.getElementById(k).checked;
      });

      await supabase.from('channel_admins').update(updates).eq('id', currentAdmin.id);
      tg.showAlert("Permisos actualizados");
      switchView('viewAdmins');
    }

    function switchView(id) {
      ['viewChannels', 'viewAdmins', 'viewEdit'].forEach(v => document.getElementById(v).style.display = 'none');
      document.getElementById(id).style.display = 'block';
    }

    loadChannels();
  </script>
</body>
</html>
