<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <style>
    :root { --bg:#020617; --glass:rgba(30,41,59,0.7); --border:rgba(255,255,255,0.1); --blue:#3b82f6; --text:#f8fafc; }
    body { background:var(--bg); color:var(--text); font-family:system-ui, sans-serif; padding:20px; }

    .nav { display:flex; gap:15px; align-items:center; margin-bottom:20px; }
    .btn-back { background:rgba(255,255,255,0.1); border:none; color:white; width:40px; height:40px; border-radius:12px; font-size:1.2em; cursor:pointer; }

    .card { background:var(--glass); border:1px solid var(--border); padding:15px; border-radius:16px; margin-bottom:10px; display:flex; align-items:center; gap:15px; cursor:pointer; transition:0.2s; backdrop-filter:blur(10px); }
    .card:active { transform:scale(0.98); background:rgba(59,130,246,0.1); }
    
    .avatar { width:45px; height:45px; background:#1e293b; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:1.1em; }
    
    /* Toggle Switch */
    .toggle-row { display:flex; justify-content:space-between; align-items:center; padding:12px; background:rgba(0,0,0,0.2); margin-bottom:8px; border-radius:12px; }
    .switch { position:relative; display:inline-block; width:46px; height:26px; }
    .switch input { opacity:0; width:0; height:0; }
    .slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#334155; transition:.4s; border-radius:34px; }
    .slider:before { position:absolute; content:""; height:20px; width:20px; left:3px; bottom:3px; background-color:white; transition:.4s; border-radius:50%; }
    input:checked + .slider { background-color:var(--blue); }
    input:checked + .slider:before { transform:translateX(20px); }

    .btn-action { width:100%; padding:15px; background:var(--blue); color:white; border:none; border-radius:16px; font-weight:bold; font-size:1em; margin-top:20px; cursor:pointer; }
    
    /* Logs para depuraci√≥n en pantalla */
    #debugLog { font-size: 0.7em; color: #facc15; margin-bottom: 10px; font-family: monospace; }
  </style>
</head>
<body>

  <div id="debugLog">Iniciando sistema...</div>

  <div id="viewChannels">
    <div class="nav">
      <a href="admin.html" class="btn-back" style="display:flex;align-items:center;justify-content:center;text-decoration:none;">‚Üê</a>
      <h2>Selecciona un Canal</h2>
    </div>
    <div id="channelList">Cargando...</div>
  </div>

  <div id="viewAdmins" style="display:none;">
    <div class="nav">
      <button class="btn-back" onclick="showView('viewChannels')">‚Üê</button>
      <h2 id="lblChannel">Admins</h2>
    </div>
    <div style="background:var(--glass); border-radius:16px; padding:10px; margin-bottom:20px; border:1px solid var(--border);">
      <h4 style="margin:5px 0 10px 5px; color:#94a3b8;">Posts por Admin</h4>
      <div id="postsChart"></div>
    </div>
    <div id="adminList"></div>
  </div>

  <div id="viewEdit" style="display:none;">
    <div class="nav">
      <button class="btn-back" onclick="showView('viewAdmins')">‚Üê</button>
      <h2 id="lblAdmin">Editar</h2>
    </div>
    <div id="permContainer"></div>
    <button class="btn-action" onclick="saveChanges()">Guardar Permisos</button>
  </div>

  <script>
    // --- CREDENCIALES ---
    const SB_URL = 'https://ndkupidhlauzroduvech.supabase.co'; 
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ka3VwaWRobGF1enJvZHV2ZWNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMzY2NzMsImV4cCI6MjA4NDYxMjY3M30.k6OufxTVTfVimTcUjYJUpLursUGjVtiTgq68xauUKG0';

    const tg = window.Telegram.WebApp;
    tg.expand();
    let currentAdmin = null;

    // Funci√≥n auxiliar para hacer peticiones directas (Igual que debug.html)
    async function apiRequest(endpoint, method = 'GET', body = null) {
      const headers = {
        'apikey': SB_KEY,
        'Authorization': `Bearer ${SB_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation' // Para recibir respuesta al actualizar
      };

      const options = { method, headers };
      if (body) options.body = JSON.stringify(body);

      const response = await fetch(`${SB_URL}/rest/v1/${endpoint}`, options);
      if (!response.ok) throw new Error(`Error API: ${response.status} ${response.statusText}`);
      return await response.json();
    }

    // 1. CARGAR CANALES
    async function init() {
      const log = document.getElementById('debugLog');
      const list = document.getElementById('channelList');
      
      try {
        log.innerText = "Conectando a base de datos...";
        
        // SIN FILTRO DE ID: Traemos todo para asegurar visualizaci√≥n
        const channels = await apiRequest('managed_channels?select=*');
        
        log.innerText = `Conexi√≥n exitosa. Canales: ${channels.length}`;

        if (channels.length === 0) {
          list.innerHTML = '<div style="text-align:center; padding:20px; color:#94a3b8">No hay canales sincronizados.</div>';
          return;
        }

        list.innerHTML = '';
        channels.forEach(c => {
          const safeTitle = c.chat_title.replace(/'/g, "\\'");
          list.innerHTML += `
          <div class="card" onclick="loadAdmins(${c.telegram_chat_id}, '${safeTitle}')">
            <div class="avatar">üì¢</div>
            <div style="flex:1;">
              <div style="font-weight:bold;">${c.chat_title}</div>
              <div style="font-size:0.8em; color:#94a3b8;">ID: ${c.telegram_chat_id}</div>
            </div>
            <div style="color:var(--blue)">Abrir ></div>
          </div>`;
        });

      } catch (e) {
        log.innerText = "Error Cr√≠tico";
        list.innerHTML = `<div style="color:red; text-align:center">Fall√≥ la conexi√≥n:<br>${e.message}</div>`;
      }
    }

    // 2. CARGAR ADMINS
    async function loadAdmins(chatId, title) {
      showView('viewAdmins');
      document.getElementById('lblChannel').innerText = title;
      const list = document.getElementById('adminList');
      list.innerHTML = 'Cargando...';

      try {
        // Petici√≥n filtrando por channel_id
        const admins = await apiRequest(`channel_admins?select=*&channel_id=eq.${chatId}`);

        if (admins.length === 0) {
          list.innerHTML = '<div style="padding:20px; text-align:center">No hay admins.</div>';
          renderChart([]);
          return;
        }

        list.innerHTML = '';
        admins.forEach(a => {
          // Guardamos el objeto completo en un atributo data para no romper el HTML
          // Usamos encodeURIComponent para seguridad extra
          const jsonData = encodeURIComponent(JSON.stringify(a));
          
          list.innerHTML += `
          <div class="card" onclick="preEditAdmin('${jsonData}')">
            <div class="avatar">${(a.first_name||'U')[0]}</div>
            <div style="flex:1;">
              <div style="font-weight:bold;">${a.first_name}</div>
              <div style="font-size:0.8em; color:#94a3b8;">${a.role || 'Admin'} ‚Ä¢ ${a.stats_posts || 0} Posts</div>
            </div>
            <div>‚öôÔ∏è</div>
          </div>`;
        });

        renderChart(admins);

      } catch (e) {
        list.innerHTML = `<div style="color:red">Error: ${e.message}</div>`;
      }
    }

    // Wrapper para decodificar el JSON seguro
    function preEditAdmin(encodedJson) {
      const admin = JSON.parse(decodeURIComponent(encodedJson));
      editAdmin(admin);
    }

    // 3. EDITAR ADMIN
    function editAdmin(admin) {
      currentAdmin = admin;
      showView('viewEdit');
      document.getElementById('lblAdmin').innerText = admin.first_name;

      const perms = [
        {k:'can_post_messages', l:'Publicar Mensajes'},
        {k:'can_edit_messages', l:'Editar Mensajes'},
        {k:'can_delete_messages', l:'Borrar Mensajes'},
        {k:'can_restrict_members', l:'Banear Usuarios'},
        {k:'can_invite_users', l:'A√±adir Usuarios'},
        {k:'can_change_info', l:'Cambiar Info'}
      ];

      const cont = document.getElementById('permContainer');
      cont.innerHTML = '';
      perms.forEach(p => {
        const checked = admin[p.k] ? 'checked' : '';
        cont.innerHTML += `
        <label class="toggle-row">
          <span>${p.l}</span>
          <label class="switch">
            <input type="checkbox" id="${p.k}" ${checked}>
            <span class="slider"></span>
          </label>
        </label>`;
      });
    }

    // 4. GUARDAR CAMBIOS (PATCH)
    async function saveChanges() {
      const btn = document.querySelector('.btn-action');
      btn.innerText = "Guardando...";
      
      const updates = {};
      ['can_post_messages','can_edit_messages','can_delete_messages','can_restrict_members','can_invite_users','can_change_info'].forEach(k => {
        updates[k] = document.getElementById(k).checked;
      });

      try {
        await apiRequest(`channel_admins?id=eq.${currentAdmin.id}`, 'PATCH', updates);
        
        if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        tg.showAlert("Guardado correctamente");
        
        // Recargar la lista para ver cambios
        loadAdmins(currentAdmin.channel_id, document.getElementById('lblChannel').innerText);
        
      } catch (e) {
        tg.showAlert("Error guardando: " + e.message);
      }
      btn.innerText = "Guardar Permisos";
    }

    function renderChart(admins) {
      const names = admins.map(a => a.first_name);
      const posts = admins.map(a => a.stats_posts || 0);

      const options = {
        series: [{ name: 'Posts', data: posts }],
        chart: { type: 'bar', height: 200, toolbar:{show:false}, background:'transparent' },
        plotOptions: { bar: { borderRadius: 4, horizontal: true, distributed: true } },
        dataLabels: { enabled: true },
        xaxis: { categories: names, labels:{style:{colors:'#94a3b8'}} },
        theme: { mode: 'dark' },
        colors: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'],
        grid: { show:false }
      };

      const chartDiv = document.querySelector("#postsChart");
      chartDiv.innerHTML = "";
      new ApexCharts(chartDiv, options).render();
    }

    function showView(id) {
      ['viewChannels', 'viewAdmins', 'viewEdit'].forEach(v => document.getElementById(v).style.display = 'none');
      document.getElementById(id).style.display = 'block';
    }

    init();
  </script>
</body>
</html>
