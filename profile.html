<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mi Perfil Kisaki</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body { background-color: #0f172a; color: #e2e8f0; padding-bottom: 80px; }

    /* HEADER PERFIL */
    .profile-header {
      background: linear-gradient(135deg, #0f172a, #1e293b);
      padding: 30px 20px;
      display: flex; flex-direction: column; align-items: center;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .avatar-ring {
      width: 86px; height: 86px;
      border-radius: 50%;
      padding: 3px;
      background: linear-gradient(45deg, #6366f1, #ec4899); /* Kisaki Gradient */
      margin-bottom: 15px;
    }
    
    .avatar-img {
      width: 100%; height: 100%; border-radius: 50%;
      background: #334155; object-fit: cover; border: 3px solid #0f172a;
    }

    .user-name { font-size: 1.4em; font-weight: bold; color: white; margin: 0; }
    .user-id { font-size: 0.8em; color: #94a3b8; font-family: monospace; margin-top: 5px; }

    /* BADGE PLAN */
    .plan-badge {
      margin-top: 10px; padding: 5px 15px;
      border-radius: 20px; font-size: 0.8em; font-weight: bold;
      text-transform: uppercase; letter-spacing: 1px;
    }
    .plan-free { background: rgba(148, 163, 184, 0.2); color: #cbd5e1; border: 1px solid #475569; }
    .plan-pro { background: rgba(99, 102, 241, 0.2); color: #818cf8; border: 1px solid #6366f1; box-shadow: 0 0 15px rgba(99, 102, 241, 0.3); }
    .plan-biz { background: rgba(236, 72, 153, 0.2); color: #f472b6; border: 1px solid #ec4899; box-shadow: 0 0 15px rgba(236, 72, 153, 0.3); }

    /* ESTADÍSTICAS */
    .stats-grid {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;
      padding: 20px; margin-top: -20px;
    }
    .stat-card {
      background: #1e293b; padding: 15px; border-radius: 12px;
      border: 1px solid #334155; text-align: center;
    }
    .stat-num { font-size: 1.5em; font-weight: bold; color: white; display: block; }
    .stat-label { font-size: 0.8em; color: #94a3b8; }

    /* MENÚ LISTA */
    .menu-list { padding: 0 20px; }
    .menu-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.05);
      color: #e2e8f0; text-decoration: none; cursor: pointer;
    }
    .menu-item:last-child { border-bottom: none; }
    .menu-icon { display: flex; align-items: center; gap: 12px; }

    /* BOTÓN UPGRADE */
    .upgrade-card {
      margin: 20px; padding: 20px;
      background: linear-gradient(135deg, #4f46e5, #4338ca);
      border-radius: 16px; position: relative; overflow: hidden;
      display: flex; align-items: center; justify-content: space-between;
    }
    .upgrade-btn {
      background: white; color: #4338ca; border: none;
      padding: 8px 16px; border-radius: 8px; font-weight: bold; font-size: 0.9em;
    }

  </style>
</head>
<body>

  <div class="page-header" style="background:#0f172a; padding:15px; border:none;">
    <a href="index.html" style="color:#94a3b8; text-decoration:none; font-size:0.9em;">← Volver</a>
  </div>

  <div class="profile-header">
    <div class="avatar-ring">
      <img src="https://via.placeholder.com/150" id="userAvatar" class="avatar-img">
    </div>
    <h2 class="user-name" id="userName">Cargando...</h2>
    <span class="user-id" id="userId">ID: ...</span>
    <div id="planBadge" class="plan-badge plan-free">Free Plan</div>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <span class="stat-num" id="botCount">0</span>
      <span class="stat-label">Bots Activos</span>
    </div>
    <div class="stat-card">
      <span class="stat-num" id="channelCount">0</span>
      <span class="stat-label">Canales</span>
    </div>
  </div>

  <div class="upgrade-card" id="upgradeBanner" onclick="window.location.href='payments.html'">
    <div>
      <h3 style="margin:0; color:white; font-size:1.1em;">Pásate a PRO</h3>
      <p style="margin:5px 0 0 0; font-size:0.8em; color:rgba(255,255,255,0.8);">Desbloquea bots ilimitados y AI.</p>
    </div>
    <button class="upgrade-btn">Mejorar</button>
  </div>

  <div class="menu-list">
    <div class="menu-item" onclick="tg.openTelegramLink('https://t.me/KisakiSupport')">
      <div class="menu-icon">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
        Soporte Técnico
      </div>
      <span style="color:#64748b;">></span>
    </div>
    <div class="menu-item" onclick="window.location.href='legal.html'">
      <div class="menu-icon">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
        Términos y Condiciones
      </div>
      <span style="color:#64748b;">></span>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    const user = tg.initDataUnsafe?.user;
    
    // Fallback para pruebas en navegador PC
    const USER_ID = user ? user.id : 1298554649; 
    const USER_NAME = user ? (user.first_name + ' ' + (user.last_name || '')).trim() : "Usuario Demo";
    const USER_PHOTO = user?.photo_url || "https://cdn-icons-png.flaticon.com/512/149/149071.png";

    // SUPABASE
    const SUPABASE_URL = 'https://ndkupidhlauzroduvech.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_fSQ9uBUx_YTfxr2QL2-kfQ_pdE2cqHv'; 
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Renderizar datos básicos
    document.getElementById('userName').innerText = USER_NAME;
    document.getElementById('userId').innerText = `ID: ${USER_ID}`;
    document.getElementById('userAvatar').src = USER_PHOTO;

    async function loadProfile() {
        // 1. Obtener o Crear Usuario en DB
        let { data: userData, error } = await supabase
            .from('users_plans')
            .select('*')
            .eq('telegram_id', USER_ID)
            .single();

        // Auto-registro si es la primera vez
        if (!userData) {
            console.log("Usuario nuevo, registrando...");
            const { data: newData } = await supabase
                .from('users_plans')
                .insert({
                    telegram_id: USER_ID,
                    username: user?.username || "Unknown",
                    plan_type: 'free',
                    avatar_url: USER_PHOTO
                })
                .select()
                .single();
            userData = newData;
        }

        // 2. Actualizar UI con Plan
        if (userData) {
            const plan = userData.plan_type || 'free';
            const badge = document.getElementById('planBadge');
            
            badge.innerText = plan + " PLAN";
            badge.className = 'plan-badge'; // reset
            
            if(plan === 'pro') badge.classList.add('plan-pro');
            else if(plan === 'business') badge.classList.add('plan-biz');
            else badge.classList.add('plan-free');

            // Ocultar banner si ya es PRO/Business
            if(plan !== 'free') document.getElementById('upgradeBanner').style.display = 'none';
        }

        // 3. Contar Bots (Clones)
        const { count: botsCount } = await supabase
            .from('bots')
            .select('*', { count: 'exact', head: true })
            .eq('owner_id', USER_ID);
        
        document.getElementById('botCount').innerText = botsCount || 0;

        // 4. Contar Canales Gestionados
        // Buscamos los bots del usuario para contar sus canales
        const { data: myBots } = await supabase.from('bots').select('id').eq('owner_id', USER_ID);
        if(myBots && myBots.length > 0) {
            const botIds = myBots.map(b => b.id);
            const { count: chanCount } = await supabase
                .from('managed_channels')
                .select('*', { count: 'exact', head: true })
                .in('bot_id', botIds);
            document.getElementById('channelCount').innerText = chanCount || 0;
        }
    }

    loadProfile();
  </script>
</body>
</html>
