<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Kisaki Analytics V4.2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <style>
    body { background-color: #0b1120; color: #e2e8f0; font-family: sans-serif; padding-bottom: 50px; }
    .dashboard-header { padding: 20px; background: linear-gradient(to bottom, #1e293b, transparent); border-bottom: 1px solid rgba(255,255,255,0.05); }
    
    .channel-select {
      background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; color: #ccf381;
      padding: 12px; border-radius: 8px; margin-top: 15px; width: 100%; font-size: 1em; outline: none;
    }

    #appStatus { font-size: 0.8em; color: #94a3b8; margin-top: 5px; font-family: monospace; }

    .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; }
    .kpi-card { background: rgba(30, 41, 59, 0.7); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
    .kpi-val { font-size: 1.4em; font-weight: bold; color: white; margin-top: 5px; }
    .kpi-sub { font-size: 0.8em; color: #cbd5e1; margin-top: 5px; }
    .green { color: #4ade80; } .red { color: #f87171; }
    
    .chart-box { margin: 15px; padding: 15px; background: #162032; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); }
    .ai-box { margin: 15px; padding: 15px; background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 12px; font-size: 0.9em; line-height: 1.4; color: #cbd5e1; }
  </style>
</head>
<body>

  <div class="dashboard-header">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2 style="margin:0;">Estad√≠sticas</h2>
      <a href="index.html" style="color:white; text-decoration:none; font-size:1.2em;">‚úï</a>
    </div>
    
    <div id="appStatus">Iniciando sistema...</div>

    <select id="channelSelector" class="channel-select" onchange="loadStats(this.value)">
      <option value="">Cargando lista...</option>
    </select>
  </div>

  <div class="kpi-grid">
    <div class="kpi-card">
      <div>Suscriptores</div>
      <div class="kpi-val" id="kpiSubs">-</div>
      <div class="kpi-sub" id="netGrowth">...</div>
    </div>
    <div class="kpi-card">
      <div>Flujo Hoy</div>
      <div class="kpi-val" id="kpiActivity">-</div>
      <div class="kpi-sub">
        <span class="green">‚¨Ü <span id="joined">0</span></span> 
        <span class="red">‚¨á <span id="left">0</span></span>
      </div>
    </div>
  </div>

  <div class="ai-box" id="aiText">
    ü§ñ Esperando selecci√≥n...
  </div>

  <div class="chart-box">
    <h4 style="margin:0 0 10px 0;">Tendencia (14 D√≠as)</h4>
    <div id="growthChart"></div>
  </div>

  <script>
    const statusEl = document.getElementById('appStatus');
    function setStatus(msg, color = '#94a3b8') {
        statusEl.innerHTML = msg;
        statusEl.style.color = color;
    }

    // Variable global para controlar la gr√°fica y evitar superposiciones
    let chartInstance = null;

    async function init() {
      try {
        setStatus("üöÄ Cargando librer√≠as...");
        const tg = window.Telegram.WebApp;
        tg.expand();

        // 1. CREDENCIALES
        const SUPABASE_URL = 'https://ndkupidhlauzroduvech.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_fSQ9uBUx_YTfxr2QL2-kfQ_pdE2cqHv'; 
        // Usamos window.supabaseClient para evitar conflictos de redeclaraci√≥n
        window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 2. OBTENER ID USUARIO
        const user = tg.initDataUnsafe?.user;
        const USER_ID = user ? user.id : 1298554649; 
        
        setStatus(`üë§ Usuario ID: ${USER_ID}`);

        // 3. CARGAR CANALES
        setStatus("üì° Buscando canales...");
        const select = document.getElementById('channelSelector');

        const { data: channels, error } = await window.supabaseClient
            .from('managed_channels')
            .select('*')
            .eq('user_id', USER_ID);

        if (error) {
            throw new Error(`Error DB: ${error.message}`);
        }

        if (!channels || channels.length === 0) {
            setStatus("‚ö†Ô∏è No tienes canales vinculados", "#f87171");
            select.innerHTML = '<option>Sin canales</option>';
            document.getElementById('aiText').innerText = "A√±ade al bot como admin a un canal para empezar.";
            return;
        }

        // 4. POBLAR SELECTOR
        setStatus(`‚úÖ ${channels.length} canales encontrados`, "#4ade80");
        select.innerHTML = ''; 
        
        const defaultOpt = document.createElement('option');
        defaultOpt.text = "üëá Selecciona un canal";
        defaultOpt.value = "";
        select.appendChild(defaultOpt);

        channels.forEach(ch => {
            const opt = document.createElement('option');
            opt.value = ch.telegram_chat_id;
            opt.innerText = ch.chat_title;
            select.appendChild(opt);
        });

        // 5. CARGAR EL PRIMERO AUTOM√ÅTICAMENTE
        if(channels.length > 0) {
           select.value = channels[0].telegram_chat_id;
           loadStats(channels[0].telegram_chat_id);
        }

      } catch (e) {
        setStatus(`‚ùå ERROR CR√çTICO: ${e.message}`, "#ef4444");
        alert("Error: " + e.message); 
      }
    }

    async function loadStats(chatId) {
        if(!chatId) return;
        setStatus("üîÑ Cargando estad√≠sticas...");
        
        try {
            const { data: stats, error } = await window.supabaseClient
                .from('daily_channel_stats')
                .select('*')
                .eq('channel_id', chatId)
                .order('recorded_at', { ascending: true })
                .limit(14);

            if(error) throw error;

            if (!stats || stats.length === 0) {
                setStatus("‚ÑπÔ∏è Sin datos recientes", "#facc15");
                updateUIEmpty();
                return;
            }

            setStatus("‚úÖ Estad√≠sticas actualizadas", "#4ade80");
            updateUI(stats);
            
        } catch (e) {
            setStatus(`‚ö†Ô∏è Error Stats: ${e.message}`, "#f87171");
        }
    }

    function updateUI(stats) {
        const latest = stats[stats.length - 1];
        
        // Actualizar KPIs (Tarjetas)
        document.getElementById('kpiSubs').innerText = latest.total_subs.toLocaleString();
        document.getElementById('joined').innerText = latest.joined_today || 0;
        document.getElementById('left').innerText = latest.left_today || 0;
        
        const net = (latest.joined_today || 0) - (latest.left_today || 0);
        const actEl = document.getElementById('kpiActivity');
        actEl.innerText = (net > 0 ? "+" : "") + net;
        actEl.style.color = net >= 0 ? '#4ade80' : '#f87171';
        
        document.getElementById('netGrowth').innerText = net >= 0 ? "‚ñ≤ Creciendo" : "‚ñº Decreciendo";

        // IA Texto
        let iaMsg = "üìä Flujo estable.";
        if(net > 0) iaMsg = `üöÄ <b>Bien hecho:</b> +${net} usuarios hoy.`;
        if(net < 0) iaMsg = `‚ö†Ô∏è <b>Atenci√≥n:</b> -${Math.abs(net)} usuarios hoy.`;
        document.getElementById('aiText').innerHTML = iaMsg;

        // --- PREPARAR DATOS PARA LA GR√ÅFICA ---
        let chartLabels = stats.map(d => d.recorded_at.slice(5)); // Mes-D√≠a
        let chartValues = stats.map(d => d.total_subs);

        // --- TRUCO VISUAL: RAMPA DE CRECIMIENTO ---
        // Si solo hay 1 dato, a√±adimos un "0" ayer para que se vea la subida verde
        if (chartValues.length === 1) {
            chartValues.unshift(0); // A√±adir 0 al inicio
            
            // Calcular etiqueta "Ayer" de forma simple para la visualizaci√≥n
            chartLabels.unshift("Inicio"); 
        }

        renderChart(chartLabels, chartValues);
    }

    function updateUIEmpty() {
        document.getElementById('kpiSubs').innerText = "0";
        document.getElementById('aiText').innerText = "El bot est√° conectado pero a√∫n no hay actividad hoy.";
        // Limpiar gr√°fica si existe
        if(chartInstance) chartInstance.destroy();
        document.getElementById('growthChart').innerHTML = "<div style='text-align:center; padding:20px; color:#64748b'>Esperando datos...</div>";
    }

    function renderChart(labels, data) {
        const options = {
            chart: { 
                type: 'area', 
                height: 200, 
                toolbar: { show: false }, 
                background: 'transparent',
                animations: { enabled: true }
            },
            series: [{ name: 'Suscriptores', data: data }],
            xaxis: { 
                categories: labels, 
                labels: { style: { colors: '#94a3b8' } },
                tooltip: { enabled: false }
            },
            colors: ['#ccf381'], // Tu color verde original
            theme: { mode: 'dark' },
            dataLabels: { enabled: false },
            grid: { borderColor: '#334155', strokeDashArray: 4 },
            stroke: { curve: 'smooth', width: 3 },
            fill: { 
                type: 'gradient', 
                gradient: { 
                    shadeIntensity: 1, 
                    opacityFrom: 0.6, 
                    opacityTo: 0.1, 
                    stops: [0, 100] 
                } 
            }
        };
        
        document.getElementById('growthChart').innerHTML = ""; // Limpiar contenedor
        
        // Destruir instancia anterior para evitar bugs visuales
        if(chartInstance) {
            chartInstance.destroy();
        }

        chartInstance = new ApexCharts(document.querySelector("#growthChart"), options);
        chartInstance.render();
    }

    // Arrancar
    init();
  </script>
</body>
</html>
