<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Kisaki Analytics V4.2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <style>
    body { background-color: #0b1120; color: #e2e8f0; font-family: sans-serif; padding-bottom: 50px; }
    .dashboard-header { padding: 20px; background: linear-gradient(to bottom, #1e293b, transparent); border-bottom: 1px solid rgba(255,255,255,0.05); }
    
    .channel-select {
      background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; color: #ccf381;
      padding: 12px; border-radius: 8px; margin-top: 15px; width: 100%; font-size: 1em; outline: none;
    }

    #appStatus { font-size: 0.8em; color: #94a3b8; margin-top: 5px; font-family: monospace; }

    .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; }
    .kpi-card { background: rgba(30, 41, 59, 0.7); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
    .kpi-val { font-size: 1.4em; font-weight: bold; color: white; margin-top: 5px; }
    .kpi-sub { font-size: 0.8em; color: #cbd5e1; margin-top: 5px; }
    .green { color: #4ade80; } .red { color: #f87171; }
    
    .chart-box { margin: 15px; padding: 15px; background: #162032; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); }
    .ai-box { margin: 15px; padding: 15px; background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 12px; font-size: 0.9em; line-height: 1.4; color: #cbd5e1; }
  </style>
</head>
<body>

  <div class="dashboard-header">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2 style="margin:0;">Estad√≠sticas</h2>
      <a href="index.html" style="color:white; text-decoration:none; font-size:1.2em;">‚úï</a>
    </div>
    <div id="appStatus">Iniciando sistema...</div>
    <select id="channelSelector" class="channel-select" onchange="loadStats(this.value)">
      <option value="">Cargando lista...</option>
    </select>
  </div>

  <div class="kpi-grid">
    <div class="kpi-card">
      <div>Suscriptores</div>
      <div class="kpi-val" id="kpiSubs">-</div>
      <div class="kpi-sub" id="netGrowth">...</div>
    </div>
    <div class="kpi-card">
      <div>Flujo Hoy</div>
      <div class="kpi-val" id="kpiActivity">-</div>
      <div class="kpi-sub">
        <span class="green">‚¨Ü <span id="joined">0</span></span> 
        <span class="red">‚¨á <span id="left">0</span></span>
      </div>
    </div>
  </div>

  <div class="ai-box" id="aiText">
    ü§ñ Esperando selecci√≥n...
  </div>

  <div class="chart-box">
    <h4 style="margin:0 0 10px 0;">Tendencia (14 D√≠as)</h4>
    <div id="growthChart"></div>
  </div>

  <script>
    const statusEl = document.getElementById('appStatus');
    function setStatus(msg, color = '#94a3b8') {
        statusEl.innerHTML = msg;
        statusEl.style.color = color;
    }

    let chartInstance = null;

    async function init() {
      try {
        setStatus("üöÄ Cargando librer√≠as...");
        const tg = window.Telegram.WebApp;
        tg.expand();

        const SUPABASE_URL = 'https://ndkupidhlauzroduvech.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_fSQ9uBUx_YTfxr2QL2-kfQ_pdE2cqHv'; 
        window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const user = tg.initDataUnsafe?.user;
        const USER_ID = user ? user.id : 1298554649; 
        
        setStatus(`üë§ ID: ${USER_ID} | üì° Buscando canales...`);
        const select = document.getElementById('channelSelector');

        const { data: channels, error } = await window.supabaseClient
            .from('managed_channels')
            .select('*')
            .eq('user_id', USER_ID);

        if (error) throw new Error(error.message);
        if (!channels || channels.length === 0) {
            setStatus("‚ö†Ô∏è Sin canales vinculados", "#f87171");
            select.innerHTML = '<option>Sin canales</option>';
            return;
        }

        setStatus(`‚úÖ ${channels.length} canales listos`, "#4ade80");
        select.innerHTML = '';
        channels.forEach(ch => {
            const opt = document.createElement('option');
            opt.value = ch.telegram_chat_id;
            opt.innerText = ch.chat_title;
            select.appendChild(opt);
        });

        if(channels.length > 0) loadStats(channels[0].telegram_chat_id);

      } catch (e) {
        setStatus(`‚ùå ERROR: ${e.message}`, "#ef4444");
      }
    }

    async function loadStats(chatId) {
        if(!chatId) return;
        setStatus("üîÑ Cargando datos...");
        try {
            const { data: stats, error } = await window.supabaseClient
                .from('daily_channel_stats')
                .select('*')
                .eq('channel_id', chatId)
                .order('recorded_at', { ascending: true })
                .limit(14);

            if(error) throw error;
            if (!stats || stats.length === 0) {
                setStatus("‚ÑπÔ∏è Sin datos a√∫n", "#facc15");
                updateUIEmpty(); return;
            }
            setStatus("‚úÖ Datos actualizados", "#4ade80");
            updateUI(stats);
        } catch (e) { setStatus(`‚ö†Ô∏è Error Stats: ${e.message}`, "#f87171"); }
    }

    function updateUI(stats) {
        const latest = stats[stats.length - 1];
        document.getElementById('kpiSubs').innerText = latest.total_subs.toLocaleString();
        const net = (latest.joined_today || 0) - (latest.left_today || 0);
        document.getElementById('kpiActivity').innerHTML = 
            `<span class="${net >= 0 ? 'green' : 'red'}">${net > 0 ? "+" : ""}${net}</span>`;
        document.getElementById('joined').innerText = latest.joined_today || 0;
        document.getElementById('left').innerText = latest.left_today || 0;
        document.getElementById('netGrowth').innerText = net >= 0 ? "‚ñ≤ Creciendo" : "‚ñº Decreciendo";
        
        let iaMsg = net > 0 ? `üöÄ <b>Positivo:</b> +${net} usuarios hoy.` : (net < 0 ? `‚ö†Ô∏è <b>Atenci√≥n:</b> ${net} usuarios hoy.` : "‚öñÔ∏è Flujo estable.");
        document.getElementById('aiText').innerHTML = iaMsg;

        // --- TRUCO VISUAL PARA GR√ÅFICA DE 1 D√çA ---
        let chartData = stats.map(d => d.total_subs);
        let chartLabels = stats.map(d => d.recorded_at.slice(5));

        // Si solo hay 1 punto, a√±adimos un punto "0" ayer para crear la rampa visual
        if (chartData.length === 1) {
            chartData.unshift(0); // A√±adir 0 al inicio
            // Calcular fecha de ayer simple para la etiqueta
            let today parts = stats[0].recorded_at.split('-');
            let yesterdayDay = parseInt(parts[2]) - 1;
            chartLabels.unshift(`${parts[1]}-${yesterdayDay.toString().padStart(2, '0')}`);
        }

        renderChart(chartLabels, chartData);
    }

    function updateUIEmpty() {
        document.getElementById('kpiSubs').innerText = "0";
        if(chartInstance) chartInstance.destroy();
        document.getElementById('growthChart').innerHTML = "<div style='text-align:center;padding:20px;color:#64748b'>Esperando actividad...</div>";
    }

    function renderChart(labels, data) {
        const options = {
            chart: { type: 'area', height: 200, toolbar: { show: false }, background: 'transparent', animations: { enabled: true } },
            series: [{ name: 'Suscriptores', data: data }],
            xaxis: { categories: labels, labels: { style: { colors: '#94a3b8' } } },
            colors: ['#ccf381'], // Tu color verde lima
            theme: { mode: 'dark' },
            dataLabels: { enabled: false },
            grid: { borderColor: '#334155', strokeDashArray: 4 },
            stroke: { curve: 'smooth', width: 3 },
            // El gradiente que ya ten√≠as configurado
            fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.5, opacityTo: 0.1, stops: [0, 100] } }
        };

        if(chartInstance) { chartInstance.destroy(); }
        chartInstance = new ApexCharts(document.querySelector("#growthChart"), options);
        chartInstance.render();
    }

    init();
  </script>
</body>
</html>
