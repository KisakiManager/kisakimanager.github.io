<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Kisaki Analytics V5.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <style>
    /* --- ESTILOS GENERALES --- */
    body { background-color: #0b1120; color: #e2e8f0; font-family: sans-serif; padding-bottom: 80px; margin: 0; }
    .dashboard-header { padding: 20px; background: linear-gradient(to bottom, #1e293b, transparent); border-bottom: 1px solid rgba(255,255,255,0.05); }

    .channel-select {
      background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; color: #ccf381;
      padding: 12px; border-radius: 8px; margin-top: 15px; width: 100%; font-size: 1em; outline: none;
    }

    #appStatus { font-size: 0.8em; color: #94a3b8; margin-top: 5px; font-family: monospace; }

    .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; }
    .kpi-card { background: rgba(30, 41, 59, 0.7); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
    .kpi-val { font-size: 1.4em; font-weight: bold; color: white; margin-top: 5px; }
    .kpi-sub { font-size: 0.8em; color: #cbd5e1; margin-top: 5px; }
    .green { color: #4ade80; } .red { color: #f87171; }

    .chart-box { margin: 15px; padding: 15px; background: #162032; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); }
    .ai-box { margin: 15px; padding: 15px; background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 12px; font-size: 0.9em; line-height: 1.4; color: #cbd5e1; }

    /* --- ESTILOS CALENDARIO (Spline Dark Replica) --- */
    .calendar-container {
      margin: 15px;
      padding: 20px;
      background: #162032; 
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.05);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .cal-title { font-weight: 600; font-size: 1.1em; color: white; }
    .cal-badge { background: #1e293b; padding: 5px 12px; border-radius: 10px; font-size: 0.85em; color: #94a3b8; border: 1px solid #334155; }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center; }
    .cal-day-name { font-size: 0.75em; color: #64748b; font-weight: bold; margin-bottom: 5px; }
    .cal-day { height: 36px; width: 100%; display: flex; align-items: center; justify-content: center; border-radius: 10px; font-size: 0.9em; color: #cbd5e1; transition: background 0.2s; }
    .cal-day.active { background: #3b82f6; color: white; font-weight: bold; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }
    .cal-day:hover:not(.active):not(.empty) { background: rgba(255,255,255,0.05); }
    .cal-day.empty { pointer-events: none; }
    .cal-actions { display: flex; gap: 10px; margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 15px; }
    .btn-cal { flex: 1; padding: 10px; border-radius: 10px; border: none; font-size: 0.85em; cursor: pointer; font-weight: 600;}
    .btn-cal-primary { background: #3b82f6; color: white; }
    .btn-cal-secondary { background: transparent; color: #94a3b8; }
    
    /* Bot√≥n flotante para volver */
    .fab-back { position: fixed; top: 20px; right: 20px; color: white; text-decoration: none; font-size: 1.5em; z-index: 100; }
  </style>
</head>
<body>

  <div class="dashboard-header">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2 style="margin:0;">Estad√≠sticas</h2>
      <a href="admin.html" class="fab-back">‚úï</a>
    </div>

    <div id="appStatus">Iniciando sistema...</div>

    <select id="channelSelector" class="channel-select" onchange="loadStats(this.value)">
      <option value="">Cargando lista...</option>
    </select>
  </div>

  <div class="kpi-grid">
    <div class="kpi-card">
      <div>Suscriptores</div>
      <div class="kpi-val" id="kpiSubs">-</div>
      <div class="kpi-sub" id="netGrowth">...</div>
    </div>
    <div class="kpi-card">
      <div>Flujo Hoy</div>
      <div class="kpi-val" id="kpiActivity">-</div>
      <div class="kpi-sub">
        <span class="green">‚¨Ü <span id="joined">0</span></span> 
        <span class="red">‚¨á <span id="left">0</span></span>
      </div>
    </div>
  </div>

  <div class="ai-box" id="aiText">
    ü§ñ Esperando selecci√≥n...
  </div>

  <div class="chart-box">
    <h4 style="margin:0 0 10px 0;">Tendencia (14 D√≠as)</h4>
    <div id="growthChart"></div>
  </div>

  <div class="calendar-container">
    <div class="cal-header">
      <div class="cal-title">Calendario</div>
      <div class="cal-badge" id="currentMonthYear">Cargando...</div>
    </div>

    <div class="cal-grid" id="calendarGrid"></div>

    <div class="cal-actions">
      <button class="btn-cal btn-cal-primary">Ver Reporte</button>
      <button class="btn-cal btn-cal-secondary">Cancelar</button>
    </div>
  </div>

  <script>
    // --- CREDENCIALES (Las Correctas / Igual que Admin Panel) ---
    const SB_URL = 'https://ndkupidhlauzroduvech.supabase.co'; 
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ka3VwaWRobGF1enJvZHV2ZWNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMzY2NzMsImV4cCI6MjA4NDYxMjY3M30.k6OufxTVTfVimTcUjYJUpLursUGjVtiTgq68xauUKG0';

    const tg = window.Telegram.WebApp;
    tg.expand();

    // Funci√≥n segura para actualizar estado
    const statusEl = document.getElementById('appStatus');
    function setStatus(msg, color = '#94a3b8') {
        statusEl.innerHTML = msg;
        statusEl.style.color = color;
    }

    // API WRAPPER (El secreto del √©xito)
    async function apiRequest(endpoint) {
      const headers = { 
        'apikey': SB_KEY, 
        'Authorization': `Bearer ${SB_KEY}`, 
        'Content-Type': 'application/json' 
      };
      const response = await fetch(`${SB_URL}/rest/v1/${endpoint}`, { method: 'GET', headers });
      if (!response.ok) throw new Error(await response.text());
      return await response.json();
    }

    async function init() {
      try {
        setStatus("üöÄ Iniciando...");
        initCalendar();

        // 1. DETECTAR USUARIO
        const user = tg.initDataUnsafe?.user;
        
        // Si no hay usuario (Navegador), no podemos filtrar por seguridad.
        if (!user) {
            setStatus("‚ö†Ô∏è Modo Navegador (Sin ID)");
        } else {
            setStatus(`üë§ ID: ${user.id}`);
        }

        // 2. CARGAR CANALES (Conexi√≥n Directa)
        setStatus("üì° Buscando canales...");
        const select = document.getElementById('channelSelector');

        // Aqu√≠ usamos user_id si existe, si no traemos todo (para debug)
        let query = 'managed_channels?select=*';
        if (user) {
            query += `&user_id=eq.${user.id}`;
        }

        const channels = await apiRequest(query);

        if (!channels || channels.length === 0) {
            setStatus("‚ö†Ô∏è No hay canales vinculados", "#f87171");
            select.innerHTML = '<option>Sin canales</option>';
            document.getElementById('aiText').innerText = "A√±ade al bot como admin a un canal para empezar.";
            return;
        }

        // 3. POBLAR SELECTOR
        setStatus(`‚úÖ ${channels.length} canales encontrados`, "#4ade80");
        select.innerHTML = ''; 

        const defaultOpt = document.createElement('option');
        defaultOpt.text = "üëá Selecciona un canal";
        defaultOpt.value = "";
        select.appendChild(defaultOpt);

        channels.forEach(ch => {
            const opt = document.createElement('option');
            opt.value = ch.telegram_chat_id;
            opt.innerText = ch.chat_title;
            select.appendChild(opt);
        });

        // 4. CARGAR EL PRIMERO AUTOM√ÅTICAMENTE
        if(channels.length > 0) {
           select.value = channels[0].telegram_chat_id; 
           loadStats(channels[0].telegram_chat_id);
        }

      } catch (e) {
        setStatus(`‚ùå ERROR: ${e.message}`, "#ef4444");
      }
    }

    // --- L√ìGICA DEL CALENDARIO (Visual) ---
    function initCalendar() {
        const date = new Date();
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        document.getElementById('currentMonthYear').innerText = `${monthNames[date.getMonth()]} ${date.getFullYear()}`;

        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';
        ["DO", "LU", "MA", "MI", "JU", "VI", "SA"].forEach(d => grid.innerHTML += `<div class="cal-day-name">${d}</div>`);

        const firstDayIndex = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
        const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();

        for (let i = 0; i < firstDayIndex; i++) grid.innerHTML += `<div class="cal-day empty"></div>`;
        for (let i = 1; i <= lastDay; i++) {
            let className = "cal-day";
            if (i === date.getDate()) className += " active";
            grid.innerHTML += `<div class="${className}">${i}</div>`;
        }
    }

    // --- CARGAR ESTAD√çSTICAS ---
    async function loadStats(chatId) {
        if(!chatId) return;
        setStatus("üîÑ Cargando datos...");

        try {
            // Consulta: √öltimos 14 d√≠as ordenados por fecha
            const stats = await apiRequest(`daily_channel_stats?select=*&channel_id=eq.${chatId}&order=recorded_at.asc&limit=14`);

            if (!stats || stats.length === 0) {
                setStatus("‚ÑπÔ∏è Sin datos recientes", "#facc15");
                updateUIEmpty();
                return;
            }

            setStatus("‚úÖ Datos actualizados", "#4ade80");
            updateUI(stats);

        } catch (e) {
            setStatus(`‚ö†Ô∏è Error Stats: ${e.message}`, "#f87171");
        }
    }

    function updateUI(stats) {
        const latest = stats[stats.length - 1]; // El √∫ltimo d√≠a registrado

        document.getElementById('kpiSubs').innerText = latest.total_subs.toLocaleString();
        document.getElementById('joined').innerText = latest.joined_today || 0;
        document.getElementById('left').innerText = latest.left_today || 0;

        const net = (latest.joined_today || 0) - (latest.left_today || 0);
        const actEl = document.getElementById('kpiActivity');
        actEl.innerText = (net > 0 ? "+" : "") + net;
        actEl.style.color = net >= 0 ? '#4ade80' : '#f87171';

        document.getElementById('netGrowth').innerText = net >= 0 ? "‚ñ≤ Creciendo" : "‚ñº Decreciendo";

        let iaMsg = "üìä Flujo estable.";
        if(net > 0) iaMsg = `üöÄ <b>Bien hecho:</b> +${net} usuarios hoy.`;
        if(net < 0) iaMsg = `‚ö†Ô∏è <b>Atenci√≥n:</b> -${Math.abs(net)} usuarios hoy.`;
        document.getElementById('aiText').innerHTML = iaMsg;

        renderChart(stats);
    }

    function updateUIEmpty() {
        document.getElementById('kpiSubs').innerText = "0";
        document.getElementById('aiText').innerText = "El bot est√° conectado pero a√∫n no hay actividad registrada.";
        document.getElementById('growthChart').innerHTML = "<div style='text-align:center; padding:20px; color:#64748b'>Esperando datos...</div>";
    }

    function renderChart(data) {
        const options = {
            chart: { type: 'area', height: 200, toolbar: { show: false }, background: 'transparent' },
            series: [{ name: 'Subs', data: data.map(d => d.total_subs) }],
            xaxis: { categories: data.map(d => d.recorded_at.slice(5)), labels: { style: { colors: '#94a3b8' } } },
            colors: ['#ccf381'],
            theme: { mode: 'dark' },
            dataLabels: { enabled: false },
            grid: { borderColor: '#334155', strokeDashArray: 4 },
            stroke: { curve: 'smooth', width: 2 },
            fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.0 } }
        };
        document.getElementById('growthChart').innerHTML = "";
        new ApexCharts(document.querySelector("#growthChart"), options).render();
    }

    // Arrancar
    init();
  </script>
</body>
</html>
