<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Kisaki Analytics - DEBUG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <style>
    body { background-color: #0b1120; color: #e2e8f0; font-family: sans-serif; padding-bottom: 50px; }
    .dashboard-header { padding: 20px; background: #1e293b; border-bottom: 1px solid rgba(255,255,255,0.1); }
    
    /* CAJA DE DEBUG ROJA */
    #debugConsole {
      background: #450a0a; border: 2px solid #ef4444; color: #fecaca;
      padding: 15px; margin: 15px; border-radius: 8px; font-family: monospace; font-size: 0.85em;
      white-space: pre-wrap; word-wrap: break-word;
    }
    
    .channel-select { width: 100%; padding: 12px; margin-top: 10px; background: #0f172a; color: white; border: 1px solid #334155; border-radius: 8px; }
    /* Ocultamos el resto para centrarnos en el error */
    .kpi-grid, .chart-container, .ai-box { opacity: 0.5; pointer-events: none; }
  </style>
</head>
<body>

  <div class="dashboard-header">
    <h1>Modo Diagnóstico</h1>
    <select id="channelSelector" class="channel-select">
      <option value="">Esperando diagnóstico...</option>
    </select>
  </div>

  <div id="debugConsole">Iniciando pruebas de conexión...</div>

  <div class="kpi-grid"></div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // 1. CREDENCIALES
    const SUPABASE_URL = 'https://ndkupidhlauzroduvech.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_fSQ9uBUx_YTfxr2QL2-kfQ_pdE2cqHv'; 
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const consoleDiv = document.getElementById('debugConsole');
    function log(msg, isError = false) {
        const line = document.createElement('div');
        line.innerHTML = (isError ? "❌ " : "ℹ️ ") + msg;
        if(isError) line.style.color = "#ff5555";
        consoleDiv.appendChild(line);
    }

    async function runDiagnostics() {
        consoleDiv.innerHTML = "<b>--- INFORME DE ESTADO ---</b><br>";
        
        // PASO 1: Identificar Usuario
        const user = tg.initDataUnsafe?.user;
        // FORZAMOS TU ID REAL SI FALLA LA DETECCIÓN (Para descartar error de Telegram)
        const TARGET_ID = user ? user.id : 1298554649; 
        
        log(`ID detectado por WebApp: <b>${user ? user.id : "No detectado (Usando Fallback)"}</b>`);
        log(`ID que usaremos para buscar: <b>${TARGET_ID}</b>`);

        // PASO 2: Prueba de Conexión a managed_channels
        log("Consultando tabla 'managed_channels'...");
        
        // Consulta simple SIN filtros extraños para ver qué devuelve
        const { data, error } = await supabase
            .from('managed_channels')
            .select('*')
            .eq('user_id', TARGET_ID);

        // PASO 3: Análisis de Resultados
        if (error) {
            log(`ERROR FATAL DE SUPABASE:`, true);
            log(JSON.stringify(error, null, 2), true);
            log("POSIBLE CAUSA: Row Level Security (RLS) está activo y bloqueando.");
            return;
        }

        if (!data) {
            log("Respuesta vacía (data is null).");
            return;
        }

        if (data.length === 0) {
            log(`Conexión exitosa, PERO array vacío.`, true);
            log(`Significa: No hay filas en 'managed_channels' donde user_id sea ${TARGET_ID}.`);
            log("Solución: Revisa que el ID en la base de datos sea EXACTAMENTE ese número.");
            return;
        }

        // ÉXITO
        log(`✅ ¡ÉXITO! Encontrados ${data.length} canales.`, false);
        consoleDiv.style.background = "#064e3b"; // Verde
        consoleDiv.style.borderColor = "#34d399";
        
        // Rellenar selector
        const selector = document.getElementById('channelSelector');
        selector.innerHTML = "";
        data.forEach(ch => {
            log(`-> Canal encontrado: ${ch.chat_title} (ID: ${ch.telegram_chat_id})`);
            const opt = document.createElement('option');
            opt.value = ch.telegram_chat_id;
            opt.text = ch.chat_title;
            selector.appendChild(opt);
        });
    }

    runDiagnostics();
  </script>
</body>
</html>
