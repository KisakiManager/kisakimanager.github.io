<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Kisaki Analytics V3.0</title> <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <style>
    body { background-color: #0b1120; color: #e2e8f0; font-family: sans-serif; padding-bottom: 50px; }
    .dashboard-header { padding: 20px; background: linear-gradient(to bottom, #1e293b, transparent); border-bottom: 1px solid rgba(255,255,255,0.05); }
    
    .channel-select {
      background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; color: #ccf381;
      padding: 10px; border-radius: 8px; margin-top: 10px; width: 100%; font-size: 1em;
    }

    /* STATUS BAR (Para saber quÃ© pasa) */
    #statusMsg { font-size: 0.8em; color: #94a3b8; margin-top: 5px; min-height: 20px;}

    .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; }
    .kpi-card { background: rgba(30, 41, 59, 0.7); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
    .kpi-val { font-size: 1.4em; font-weight: bold; color: white; }
    .kpi-sub { font-size: 0.8em; color: #cbd5e1; margin-top: 5px; }
    .green { color: #4ade80; } .red { color: #f87171; }
    
    .chart-box { margin: 15px; padding: 15px; background: #162032; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); }
    .ai-box { margin: 15px; padding: 15px; background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 12px; font-size: 0.9em; line-height: 1.4; color: #cbd5e1; }
  </style>
</head>
<body>

  <div class="dashboard-header">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2 style="margin:0;">Kisaki V3.0</h2> <a href="index.html" style="color:white; text-decoration:none;">âœ•</a>
    </div>
    
    <div id="statusMsg">Conectando...</div>

    <select id="channelSelector" class="channel-select" onchange="loadStats(this.value)">
      <option value="">Cargando lista...</option>
    </select>
  </div>

  <div class="kpi-grid">
    <div class="kpi-card">
      <div>Suscriptores</div>
      <div class="kpi-val" id="kpiSubs">-</div>
      <div class="kpi-sub" id="netGrowth">...</div>
    </div>
    <div class="kpi-card">
      <div>Actividad Hoy</div>
      <div class="kpi-val" id="kpiActivity">-</div>
      <div class="kpi-sub">
        <span class="green">â¬† <span id="joined">0</span></span> 
        <span class="red">â¬‡ <span id="left">0</span></span>
      </div>
    </div>
  </div>

  <div class="ai-box" id="aiText">ðŸ¤– Selecciona un canal para analizar.</div>

  <div class="chart-box">
    <h4 style="margin:0 0 10px 0;">Crecimiento (14 DÃ­as)</h4>
    <div id="growthChart"></div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // CREDENCIALES
    const SUPABASE_URL = 'https://ndkupidhlauzroduvech.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_fSQ9uBUx_YTfxr2QL2-kfQ_pdE2cqHv'; 
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const statusEl = document.getElementById('statusMsg');
    
    // ID USUARIO (Prioridad: Telegram > Fallback Tuyo)
    const user = tg.initDataUnsafe?.user;
    const USER_ID = user ? user.id : 1298554649; 

    async function init() {
        statusEl.innerText = `Buscando canales para ID: ${USER_ID}`;
        
        // 1. OBTENER CANALES
        const { data: channels, error } = await supabase
            .from('managed_channels')
            .select('*')
            .eq('user_id', USER_ID)
            .eq('is_active', true);

        const select = document.getElementById('channelSelector');
        select.innerHTML = '';

        if (error) {
            statusEl.innerText = "Error Supabase: " + error.message;
            statusEl.style.color = "#f87171";
            return;
        }

        if (!channels || channels.length === 0) {
            statusEl.innerText = "No se encontraron canales vinculados.";
            select.innerHTML = '<option>Sin canales</option>';
            document.getElementById('aiText').innerText = "ðŸ’¡ AÃ±ade al bot @KisakiManagerBot como admin en tu canal y espera el mensaje de confirmaciÃ³n.";
            return;
        }

        statusEl.innerText = `âœ… ${channels.length} canales encontrados.`;
        statusEl.style.color = "#4ade80";

        channels.forEach(ch => {
            const opt = document.createElement('option');
            opt.value = ch.telegram_chat_id;
            opt.innerText = ch.chat_title;
            select.appendChild(opt);
        });

        // Cargar primero
        loadStats(channels[0].telegram_chat_id);
    }

    async function loadStats(chatId) {
        if(!chatId) return;
        
        // 2. OBTENER ESTADÃSTICAS
        const { data: stats } = await supabase
            .from('daily_channel_stats')
            .select('*')
            .eq('channel_id', chatId)
            .order('recorded_at', { ascending: true })
            .limit(14);

        if (!stats || stats.length === 0) {
            document.getElementById('kpiSubs').innerText = "0";
            document.getElementById('aiText').innerText = "Esperando primeros datos del bot...";
            return;
        }

        const latest = stats[stats.length - 1];
        
        // KPIs
        document.getElementById('kpiSubs').innerText = latest.total_subs.toLocaleString();
        document.getElementById('joined').innerText = latest.joined_today || 0;
        document.getElementById('left').innerText = latest.left_today || 0;
        
        const net = (latest.joined_today || 0) - (latest.left_today || 0);
        const actEl = document.getElementById('kpiActivity');
        actEl.innerText = (net > 0 ? "+" : "") + net;
        actEl.style.color = net >= 0 ? '#4ade80' : '#f87171';
        
        document.getElementById('netGrowth').innerText = net >= 0 ? "â–² Creciendo" : "â–¼ Decreciendo";

        // IA
        let iaMsg = "ðŸ“Š Flujo estable.";
        if(net > 0) iaMsg = `ðŸš€ <b>Â¡Bien hecho!</b> Has ganado ${net} usuarios hoy.`;
        if(net < 0) iaMsg = `âš ï¸ <b>AtenciÃ³n:</b> Hoy han salido ${latest.left_today} usuarios.`;
        document.getElementById('aiText').innerHTML = iaMsg;

        // GRÃFICA
        renderChart(stats);
    }

    function renderChart(data) {
        const options = {
            chart: { type: 'area', height: 180, toolbar: { show: false }, background: 'transparent' },
            series: [{ name: 'Subs', data: data.map(d => d.total_subs) }],
            xaxis: { categories: data.map(d => d.recorded_at.slice(5)), labels: { style: { colors: '#94a3b8' } } },
            colors: ['#ccf381'],
            theme: { mode: 'dark' },
            dataLabels: { enabled: false },
            grid: { borderColor: '#334155' }
        };
        document.getElementById('growthChart').innerHTML = "";
        new ApexCharts(document.querySelector("#growthChart"), options).render();
    }

    init();
  </script>
</body>
</html>
