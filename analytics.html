<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Kisaki Analytics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="style.css">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <style>
    /* ESTILO CYBER DASHBOARD */
    body { background-color: #0b1120; color: #e2e8f0; padding-bottom: 50px; }

    .dashboard-header {
      padding: 20px;
      background: linear-gradient(to bottom, #1e293b, transparent);
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    /* SELECTOR DE CANALES */
    .channel-select {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid #334155;
      color: #ccf381;
      padding: 5px 10px;
      border-radius: 8px;
      font-size: 0.9em;
      margin-top: 5px;
      outline: none;
      width: 100%;
      max-width: 250px;
    }

    /* KPI CARDS */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      padding: 15px;
      margin-top: -10px;
    }

    .kpi-card {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 15px;
      position: relative;
    }

    .kpi-title { font-size: 0.8em; color: #94a3b8; display: block; margin-bottom: 5px; }
    .kpi-value { font-size: 1.4em; font-weight: 700; color: #fff; }
    .kpi-trend { font-size: 0.75em; display: flex; align-items: center; gap: 4px; margin-top: 5px; }
    .trend-up { color: #ccf381; } 
    .trend-down { color: #ef4444; }
    .trend-neutral { color: #94a3b8; }

    /* SECCIONES DE GR√ÅFICOS */
    .chart-container {
      margin: 15px;
      padding: 15px;
      background: #162032;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.05);
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .section-title {
      font-size: 1em; font-weight: 600; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;
    }

    /* AI INSIGHT BOX */
    .ai-box {
      margin: 15px;
      padding: 15px;
      background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(147,51,234,0.1));
      border: 1px solid rgba(59,130,246,0.3);
      border-radius: 12px;
    }
    .ai-header { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; color: #60a5fa; font-weight: bold; }

    /* PREMIUM LOCK */
    .blur-overlay { filter: blur(4px); pointer-events: none; user-select: none; }
    .premium-lock {
      position: absolute; top:0; left:0; width:100%; height:100%;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: rgba(11, 17, 32, 0.8); z-index: 10;
      border-radius: 16px;
    }
    
    .loading-spinner { text-align: center; color: #94a3b8; font-size: 0.9em; padding: 20px; }
  </style>
</head>
<body>

  <div class="dashboard-header">
    <a href="index.html" style="color:white; text-decoration:none; display:flex; align-items:center; gap:10px; font-size:0.9em;">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
      Volver
    </a>
    <h1 style="margin: 10px 0 5px 0; font-size: 1.5em;">Panel de Control</h1>
    
    <select id="channelSelector" class="channel-select" onchange="loadChannelStats(this.value)">
      <option value="">Cargando canales...</option>
    </select>
  </div>

  <div class="kpi-grid">
    <div class="kpi-card">
      <span class="kpi-title">Suscriptores</span>
      <div class="kpi-value" id="kpiSubs">...</div>
      <div class="kpi-trend" id="kpiSubsTrend">-</div>
    </div>
    <div class="kpi-card">
      <span class="kpi-title">Vistas (Est.)</span>
      <div class="kpi-value" id="kpiViews">...</div>
      <div class="kpi-trend trend-neutral">~ Calculado</div>
    </div>
    <div class="kpi-card">
      <span class="kpi-title">Engagement</span>
      <div class="kpi-value">N/A</div>
      <div class="kpi-trend trend-neutral">Requiere Posts</div>
    </div>
    <div class="kpi-card">
      <span class="kpi-title">Valor (Stars)</span>
      <div class="kpi-value" id="kpiValue">0</div>
      <div class="kpi-trend trend-up">Est. Mensual</div>
    </div>
  </div>

  <div class="ai-box">
    <div class="ai-header">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10H12V2z"></path></svg>
      Kisaki AI Insight
    </div>
    <p id="aiInsightText" style="font-size: 0.9em; line-height: 1.4; color: #cbd5e1; margin: 0;">
      Recopilando datos para generar predicciones... Vuelve ma√±ana.
    </p>
  </div>

  <div class="chart-container">
    <div class="section-title">
      Crecimiento Real
      <span style="font-size:0.7em; background:#334155; padding:2px 6px; border-radius:4px;">Hist√≥rico</span>
    </div>
    <div id="growthChart"></div>
  </div>

  <div class="chart-container" style="position:relative;">
    <div class="section-title">Mapa de Calor (Horarios)</div>

    <div class="premium-lock">
      <div style="font-size:30px; margin-bottom:10px;">üîí</div>
      <div style="font-weight:bold; color:white;">Funci√≥n Premium</div>
      <button class="btn-telegram-cta" onclick="window.location.href='upgrade.html'" style="margin-top:10px; width:auto; padding: 8px 20px; background: #6366f1;">Desbloquear</button>
    </div>

    <div id="heatmapChart" class="blur-overlay"></div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // CREDENCIALES SUPABASE
    const SUPABASE_URL = 'https://ndkupidhlauzroduvech.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_fSQ9uBUx_YTfxr2QL2-kfQ_pdE2cqHv'; 
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let chartInstance = null;

    // 1. INICIALIZAR Y CARGAR CANALES
    async function initDashboard() {
        const selector = document.getElementById('channelSelector');
        
        // Obtener canales de la tabla 'managed_channels' (El Radar)
        const { data: channels, error } = await supabase
            .from('managed_channels')
            .select('*');

        selector.innerHTML = '';
        
        if (!channels || channels.length === 0) {
            selector.innerHTML = '<option>No hay canales registrados</option>';
            document.getElementById('aiInsightText').innerText = "A√±ade al bot como Admin en un canal para empezar.";
            return;
        }

        // Poblar el select
        channels.forEach((ch, index) => {
            const opt = document.createElement('option');
            opt.value = ch.telegram_chat_id;
            opt.text = ch.chat_title || "Canal Sin Nombre";
            selector.appendChild(opt);
        });

        // Cargar datos del primer canal por defecto
        if(channels.length > 0) {
            loadChannelStats(channels[0].telegram_chat_id);
        }
    }

    // 2. CARGAR ESTAD√çSTICAS DEL CANAL SELECCIONADO
    async function loadChannelStats(chatId) {
        // Consultar historial en 'channel_stats'
        const { data: stats, error } = await supabase
            .from('channel_stats')
            .select('*')
            .eq('telegram_chat_id', chatId)
            .order('recorded_at', { ascending: true }); // Ordenar cronol√≥gicamente para la gr√°fica

        if (!stats || stats.length === 0) {
            updateUI_Empty();
            return;
        }

        // Procesar datos para la gr√°fica y KPIs
        const latest = stats[stats.length - 1]; // El √∫ltimo registro
        const previous = stats.length > 1 ? stats[stats.length - 2] : latest;
        
        // --- ACTUALIZAR KPIs ---
        
        // A. Suscriptores
        const subDiff = latest.total_subs - previous.total_subs;
        const trendEl = document.getElementById('kpiSubsTrend');
        
        document.getElementById('kpiSubs').innerText = latest.total_subs.toLocaleString();
        
        if(subDiff > 0) {
            trendEl.innerHTML = `‚ñ≤ +${subDiff}`;
            trendEl.className = 'kpi-trend trend-up';
        } else if (subDiff < 0) {
            trendEl.innerHTML = `‚ñº ${subDiff}`;
            trendEl.className = 'kpi-trend trend-down';
        } else {
            trendEl.innerHTML = `= Sin cambios`;
            trendEl.className = 'kpi-trend trend-neutral';
        }

        // B. Vistas Estimadas (Heur√≠stica: 20% de subs son vistas promedio)
        const estViews = Math.floor(latest.total_subs * 0.2);
        document.getElementById('kpiViews').innerText = estViews.toLocaleString();

        // C. Valor Estimado (Ej: 0.01 stars por sub)
        const estValue = Math.floor(latest.total_subs * 0.01);
        document.getElementById('kpiValue').innerText = estValue;

        // --- ACTUALIZAR GR√ÅFICA ---
        const dates = stats.map(s => new Date(s.recorded_at).toLocaleDateString(undefined, {weekday:'short'}));
        const values = stats.map(s => s.total_subs);

        renderGrowthChart(dates, values);

        // --- AI INSIGHT SIMULADO ---
        if(subDiff > 0) {
            document.getElementById('aiInsightText').innerHTML = `¬°Tendencia Positiva! Tu canal ha ganado <b>${subDiff}</b> suscriptores desde la √∫ltima medici√≥n. Contin√∫a con la estrategia actual.`;
        } else {
            document.getElementById('aiInsightText').innerHTML = `El crecimiento est√° estancado. Considera publicar contenido interactivo (Encuestas) para reactivar la audiencia.`;
        }
    }

    function updateUI_Empty() {
        document.getElementById('kpiSubs').innerText = "0";
        document.getElementById('growthChart').innerHTML = "<div class='loading-spinner'>Esperando datos del Bot (24h)...</div>";
    }

    // 3. RENDERIZAR APEXCHART
    function renderGrowthChart(categories, data) {
        const options = {
            series: [{ name: 'Subs', data: data }],
            chart: {
                type: 'area',
                height: 200,
                toolbar: { show: false },
                background: 'transparent',
                animations: { enabled: true }
            },
            colors: ['#ccf381'],
            stroke: { curve: 'smooth', width: 2 },
            fill: {
                type: 'gradient',
                gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.0, stops: [0, 90, 100] }
            },
            dataLabels: { enabled: false },
            theme: { mode: 'dark' },
            grid: { borderColor: '#334155', strokeDashArray: 4 },
            xaxis: {
                categories: categories,
                labels: { style: { colors: '#94a3b8' } },
                tooltip: { enabled: false }
            },
            yaxis: { show: false }
        };

        if(chartInstance) {
            chartInstance.updateOptions({
                xaxis: { categories: categories },
                series: [{ data: data }]
            });
        } else {
            chartInstance = new ApexCharts(document.querySelector("#growthChart"), options);
            chartInstance.render();
        }
    }

    // 4. GR√ÅFICA DUMMY (HEATMAP LOCKED)
    const heatmapOptions = {
      series: [
        { name: '10:00', data: [20, 30, 40, 50] },
        { name: '14:00', data: [10, 20, 60, 40] },
        { name: '18:00', data: [50, 60, 90, 80] }
      ],
      chart: { type: 'heatmap', height: 200, toolbar: { show: false }, background: 'transparent' },
      colors: ['#3b82f6'],
      theme: { mode: 'dark' },
      dataLabels: { enabled: false }
    };
    new ApexCharts(document.querySelector("#heatmapChart"), heatmapOptions).render();

    // ARRANCAR
    initDashboard();

  </script>
</body>
</html>
