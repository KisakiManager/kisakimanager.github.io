<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Diagn√≥stico Supabase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { background: #000; color: #0f0; font-family: monospace; padding: 20px; font-size: 12px; }
    .log-entry { margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 2px; word-break: break-all; }
    .error { color: #f00; font-weight: bold; }
    .success { color: #0f0; }
    .warn { color: #ff0; }
  </style>
</head>
<body>
  <h3>üïµÔ∏è‚Äç‚ôÇÔ∏è MODO DIAGN√ìSTICO</h3>
  <div id="console">Iniciando pruebas...<br></div>

  <script>
    // 1. CONFIGURACI√ìN
    const SUPABASE_URL = 'https://ndkupidhlauzroduvech.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_fSQ9uBUx_YTfxr2QL2-kfQ_pdE2cqHv'; // Aseg√∫rate que esta sea tu ANON KEY
    
    // Funci√≥n de log en pantalla
    const consoleDiv = document.getElementById('console');
    function log(msg, type = 'info') {
      const div = document.createElement('div');
      div.className = 'log-entry ' + type;
      div.innerHTML = `> ${msg}`;
      consoleDiv.appendChild(div);
    }

    async function runTests() {
      try {
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // --- PRUEBA 0: DATOS DE TELEGRAM ---
        const user = tg.initDataUnsafe?.user;
        const userId = user ? user.id : 1298554649; // Fallback
        log(`ID Usuario (Telegram): ${userId} (Tipo: ${typeof userId})`);

        // --- PRUEBA 1: CONEXI√ìN B√ÅSICA ---
        log("Intentando conectar con Supabase...");
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        if (!supabase) {
          log("‚ùå Error fatal: No se pudo iniciar el cliente Supabase.", "error");
          return;
        }
        log("Cliente iniciado. Probando lectura p√∫blica...");

        // --- PRUEBA 2: LEER TABLA 'users' (Sin filtros) ---
        // Esto verifica si la conexi√≥n funciona y si RLS bloquea todo
        const test1 = await supabase.from('users').select('*').limit(1);
        
        if (test1.error) {
          log(`‚ùå ERROR CONEXI√ìN: ${test1.error.message}`, "error");
          log(`C√≥digo: ${test1.error.code} | Hint: ${test1.error.hint}`, "error");
          log("‚ö†Ô∏è CAUSA PROBABLE: Row Level Security (RLS) est√° activo y no hay pol√≠ticas.", "warn");
        } else {
          log(`‚úÖ Conexi√≥n exitosa a 'users'. Filas: ${test1.data.length}`, "success");
        }

        // --- PRUEBA 3: BUSCAR TUS CANALES ---
        log(`Buscando canales para user_id: ${userId}...`);
        
        const test2 = await supabase
          .from('managed_channels')
          .select('*')
          .eq('user_id', userId);

        if (test2.error) {
           log(`‚ùå Error buscando canales: ${test2.error.message}`, "error");
        } else if (test2.data.length === 0) {
           log(`‚ö†Ô∏è Array vac√≠o. No se encontraron canales.`, "warn");
           log(`Verifica en Supabase -> managed_channels si user_id es ${userId}`, "warn");
           
           // Intento desesperado: Ver si hay ALG√öN canal
           const test3 = await supabase.from('managed_channels').select('*').limit(1);
           if(test3.data && test3.data.length > 0) {
             log(`DATO CURIOSO: Hay canales en la DB (ej: user_id ${test3.data[0].user_id}), pero no coinciden con el tuyo.`, "warn");
           }
        } else {
           log(`‚úÖ ¬°√âXITO TOTAL! Se encontraron ${test2.data.length} canales.`, "success");
           test2.data.forEach(c => log(`- ${c.chat_title} (ID: ${c.telegram_chat_id})`));
        }

      } catch (e) {
        log(`‚ùå CRASH JS: ${e.message}`, "error");
      }
    }

    runTests();
  </script>
</body>
</html>
