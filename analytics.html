<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Kisaki Analytics V4.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <style>
    body { background-color: #0b1120; color: #e2e8f0; font-family: sans-serif; padding-bottom: 50px; }
    .dashboard-header { padding: 20px; background: linear-gradient(to bottom, #1e293b, transparent); border-bottom: 1px solid rgba(255,255,255,0.05); }
    
    .channel-select {
      background: rgba(15, 23, 42, 0.8); border: 1px solid #334155; color: #ccf381;
      padding: 12px; border-radius: 8px; margin-top: 15px; width: 100%; font-size: 1em; outline: none;
    }

    .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; }
    .kpi-card { background: rgba(30, 41, 59, 0.7); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
    .kpi-val { font-size: 1.4em; font-weight: bold; color: white; margin-top: 5px; }
    .kpi-sub { font-size: 0.8em; color: #cbd5e1; margin-top: 5px; }
    .green { color: #4ade80; } .red { color: #f87171; }
    
    .chart-box { margin: 15px; padding: 15px; background: #162032; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); }
    .ai-box { margin: 15px; padding: 15px; background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 12px; font-size: 0.9em; line-height: 1.4; color: #cbd5e1; }
    
    /* Indicador de carga */
    #loadingMsg { text-align:center; color:#94a3b8; font-size:0.9em; margin-top:10px; }
  </style>
</head>
<body>

  <div class="dashboard-header">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2 style="margin:0;">Estad√≠sticas</h2>
      <a href="index.html" style="color:white; text-decoration:none; font-size:1.2em;">‚úï</a>
    </div>
    
    <div id="loadingMsg">Conectando con tus canales...</div>

    <select id="channelSelector" class="channel-select" onchange="loadStats(this.value)" disabled>
      <option value="">Cargando...</option>
    </select>
  </div>

  <div class="kpi-grid">
    <div class="kpi-card">
      <div>Suscriptores</div>
      <div class="kpi-val" id="kpiSubs">-</div>
      <div class="kpi-sub" id="netGrowth">...</div>
    </div>
    <div class="kpi-card">
      <div>Flujo Hoy</div>
      <div class="kpi-val" id="kpiActivity">-</div>
      <div class="kpi-sub">
        <span class="green">‚¨Ü <span id="joined">0</span></span> 
        <span class="red">‚¨á <span id="left">0</span></span>
      </div>
    </div>
  </div>

  <div class="ai-box" id="aiText">
    ü§ñ Kisaki AI est√° lista. Selecciona un canal arriba.
  </div>

  <div class="chart-box">
    <h4 style="margin:0 0 10px 0;">Tendencia (14 D√≠as)</h4>
    <div id="growthChart"></div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // 1. CREDENCIALES
    const SUPABASE_URL = 'https://ndkupidhlauzroduvech.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_fSQ9uBUx_YTfxr2QL2-kfQ_pdE2cqHv'; 
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // 2. OBTENER ID USUARIO
    const user = tg.initDataUnsafe?.user;
    const USER_ID = user ? user.id : 1298554649; // Fallback probado en diagn√≥stico

    async function init() {
        const loadingEl = document.getElementById('loadingMsg');
        const select = document.getElementById('channelSelector');

        // --- CARGAR CANALES (Igual que en el diagn√≥stico) ---
        const { data: channels, error } = await supabase
            .from('managed_channels')
            .select('*')
            .eq('user_id', USER_ID);

        if (error || !channels || channels.length === 0) {
            loadingEl.innerText = "No se encontraron canales vinculados.";
            loadingEl.style.color = "#f87171";
            select.innerHTML = '<option>Sin canales</option>';
            return;
        }

        // √âxito cargando canales
        loadingEl.style.display = 'none';
        select.disabled = false;
        select.innerHTML = ''; // Limpiar

        channels.forEach(ch => {
            const opt = document.createElement('option');
            opt.value = ch.telegram_chat_id;
            opt.innerText = ch.chat_title;
            select.appendChild(opt);
        });

        // Cargar el primero autom√°ticamente
        loadStats(channels[0].telegram_chat_id);
    }

    async function loadStats(chatId) {
        if(!chatId) return;
        
        // --- CARGAR DATOS (Tabla Nueva: daily_channel_stats) ---
        // Nota: Si acabas de migrar, esta tabla puede tener pocos datos hoy.
        const { data: stats } = await supabase
            .from('daily_channel_stats')
            .select('*')
            .eq('channel_id', chatId)
            .order('recorded_at', { ascending: true })
            .limit(14);

        if (!stats || stats.length === 0) {
            // Caso: Canal nuevo o tabla vac√≠a
            document.getElementById('kpiSubs').innerText = "Sin datos";
            document.getElementById('aiText').innerText = "üí° El bot acaba de conectarse. Espera a que recopile datos hoy.";
            document.getElementById('growthChart').innerHTML = "<div style='text-align:center; padding:20px; color:#64748b'>Gr√°fica vac√≠a (Esperando actividad)</div>";
            return;
        }

        const latest = stats[stats.length - 1];
        
        // KPIs
        document.getElementById('kpiSubs').innerText = latest.total_subs.toLocaleString();
        document.getElementById('joined').innerText = latest.joined_today || 0;
        document.getElementById('left').innerText = latest.left_today || 0;
        
        const net = (latest.joined_today || 0) - (latest.left_today || 0);
        const actEl = document.getElementById('kpiActivity');
        actEl.innerText = (net > 0 ? "+" : "") + net;
        actEl.style.color = net >= 0 ? '#4ade80' : '#f87171';
        
        document.getElementById('netGrowth').innerText = net >= 0 ? "‚ñ≤ Creciendo" : "‚ñº Decreciendo";

        // IA SIMPLE
        let iaMsg = "üìä Flujo estable.";
        if(net > 0) iaMsg = `üöÄ <b>Tendencia Positiva:</b> Has ganado ${net} usuarios hoy.`;
        if(net < 0) iaMsg = `‚ö†Ô∏è <b>Alerta:</b> Hoy salieron ${latest.left_today} usuarios.`;
        document.getElementById('aiText').innerHTML = iaMsg;

        // GR√ÅFICA
        renderChart(stats);
    }

    function renderChart(data) {
        const options = {
            chart: { type: 'area', height: 200, toolbar: { show: false }, background: 'transparent' },
            series: [{ name: 'Subs', data: data.map(d => d.total_subs) }],
            xaxis: { categories: data.map(d => d.recorded_at.slice(5)), labels: { style: { colors: '#94a3b8' } } },
            colors: ['#ccf381'],
            theme: { mode: 'dark' },
            dataLabels: { enabled: false },
            grid: { borderColor: '#334155', strokeDashArray: 4 },
            stroke: { curve: 'smooth', width: 2 },
            fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.0 } }
        };
        document.getElementById('growthChart').innerHTML = "";
        new ApexCharts(document.querySelector("#growthChart"), options).render();
    }

    init();
  </script>
</body>
</html>
