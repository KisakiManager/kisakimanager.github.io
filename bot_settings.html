<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Configuraci贸n de Bot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body { background-color: #0f172a; color: #e2e8f0; padding-bottom: 80px; }

    /* Header con degradado */
    .settings-header {
      padding: 30px 20px;
      background: linear-gradient(135deg, #4f46e5, #312e81);
      border-radius: 0 0 25px 25px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px -10px rgba(79, 70, 229, 0.5);
    }

    /* Interruptores (Toggles) Estilo iOS */
    .switch-container {
      display: flex; justify-content: space-between; align-items: center;
      background: #1e293b; padding: 15px; border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.05); margin-bottom: 10px;
    }
    .switch-label h3 { margin: 0; font-size: 1em; color: white; }
    .switch-label p { margin: 3px 0 0 0; font-size: 0.8em; color: #94a3b8; }

    .toggle {
      position: relative; display: inline-block; width: 50px; height: 28px;
    }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #334155; transition: .4s; border-radius: 34px;
    }
    .slider:before {
      position: absolute; content: ""; height: 20px; width: 20px;
      left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;
    }
    input:checked + .slider { background-color: #ccf381; } /* Verde Kisaki */
    input:checked + .slider:before { transform: translateX(22px); }

    /* Bot贸n Guardar Flotante */
    .fab-save {
      position: fixed; bottom: 20px; right: 20px;
      width: 56px; height: 56px;
      background: #ccf381; color: #0f172a;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 15px rgba(204, 243, 129, 0.4);
      cursor: pointer; z-index: 50;
      border: none; font-size: 24px;
      transition: transform 0.2s;
    }
    .fab-save:active { transform: scale(0.9); }
    
    .loading-overlay {
        position: fixed; top:0; left:0; width:100%; height:100%;
        background: #0f172a; z-index: 999;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
  </style>
</head>
<body>

  <div class="loading-overlay" id="mainLoader">
    <div class="loading-spinner"></div>
    <p style="color:#94a3b8; margin-top:10px;">Conectando con el N煤cleo...</p>
  </div>

  <div class="settings-header">
    <a href="clones.html" style="color:rgba(255,255,255,0.7); text-decoration:none; display:flex; align-items:center; gap:5px; font-size:0.9em; margin-bottom:10px;">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg> Volver
    </a>
    <h1 style="margin:0; font-size:1.8em;" id="botNameTitle">Cargando...</h1>
    <span style="color: rgba(255,255,255,0.6); font-family:monospace;" id="botTokenDisplay">Token: ...</span>
  </div>

  <div class="container">
    
    <h3 style="color:#64748b; margin: 20px 0 10px 5px; font-size:0.9em; text-transform:uppercase;">M贸dulos del Sistema</h3>

    <div class="switch-container">
      <div class="switch-label">
        <h3>Bienvenida</h3>
        <p>Saludar a nuevos usuarios.</p>
      </div>
      <label class="toggle">
        <input type="checkbox" id="check_welcome">
        <span class="slider"></span>
      </label>
    </div>

    <div class="switch-container">
      <div class="switch-label">
        <h3>Captcha</h3>
        <p>Verificaci贸n antispam al entrar.</p>
      </div>
      <label class="toggle">
        <input type="checkbox" id="check_captcha">
        <span class="slider"></span>
      </label>
    </div>

    <div class="switch-container">
      <div class="switch-label">
        <h3>Moderaci贸n IA</h3>
        <p>Filtrar insultos y spam.</p>
      </div>
      <label class="toggle">
        <input type="checkbox" id="check_moderation">
        <span class="slider"></span>
      </label>
    </div>

    <h3 style="color:#64748b; margin: 30px 0 10px 5px; font-size:0.9em; text-transform:uppercase;">Zona de Peligro</h3>
    
    <div class="switch-container" style="border-color: rgba(239, 68, 68, 0.3); background: rgba(239, 68, 68, 0.05);">
      <div class="switch-label">
        <h3 style="color: #f87171;">Apagar Bot</h3>
        <p>Detener todas las operaciones.</p>
      </div>
      <label class="toggle">
        <input type="checkbox" id="check_status">
        <span class="slider" style="background-color: #334155;"></span>
      </label>
    </div>

  </div>

  <button class="fab-save" onclick="saveSettings()">
    
  </button>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    
    // Obtener ID del bot de la URL (Ej: bot_settings.html?id=UUID)
    const urlParams = new URLSearchParams(window.location.search);
    const BOT_ID = urlParams.get('id');

    const SUPABASE_URL = 'https://ndkupidhlauzroduvech.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_fSQ9uBUx_YTfxr2QL2-kfQ_pdE2cqHv'; 
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // 1. CARGAR CONFIGURACIN
    async function loadConfig() {
      if (!BOT_ID) {
        alert("Error: No se especific贸 un ID de bot.");
        window.location.href = "clones.html";
        return;
      }

      const { data, error } = await supabase
        .from('bots')
        .select('*')
        .eq('id', BOT_ID)
        .single();

      if (error || !data) {
        alert("Error cargando bot.");
        return;
      }

      // Rellenar UI
      document.getElementById('botNameTitle').innerText = data.bot_username || "Bot Sin Nombre";
      document.getElementById('botTokenDisplay').innerText = "Token: ..." + data.bot_token.substr(-5);
      
      // Configurar Toggles seg煤n JSON de la base de datos
      const config = data.modules_config || {};
      document.getElementById('check_welcome').checked = config.welcome === true;
      document.getElementById('check_captcha').checked = config.captcha === true;
      document.getElementById('check_moderation').checked = config.moderation === true;
      
      // Toggle de estado (Si est谩 'active', el toggle est谩 encendido)
      document.getElementById('check_status').checked = data.status === 'active';

      // Quitar loader
      document.getElementById('mainLoader').style.display = 'none';
    }

    // 2. GUARDAR CONFIGURACIN
    async function saveSettings() {
      const btn = document.querySelector('.fab-save');
      btn.style.transform = "scale(0.8)";
      
      // Construir el nuevo JSON
      const newConfig = {
        welcome: document.getElementById('check_welcome').checked,
        captcha: document.getElementById('check_captcha').checked,
        moderation: document.getElementById('check_moderation').checked
      };

      const newStatus = document.getElementById('check_status').checked ? 'active' : 'paused';

      const { error } = await supabase
        .from('bots')
        .update({ 
            modules_config: newConfig,
            status: newStatus
        })
        .eq('id', BOT_ID);

      if (error) {
        alert("Error al guardar: " + error.message);
      } else {
        tg.showPopup({
            title: '隆Guardado!',
            message: 'La configuraci贸n se ha actualizado en la nube.',
            buttons: [{type: 'ok'}]
        });
      }
      
      setTimeout(() => btn.style.transform = "scale(1)", 200);
    }

    // Iniciar
    loadConfig();
  </script>
</body>
</html>
