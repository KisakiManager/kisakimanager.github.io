<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Admin Rating</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  
  <style>
    /* Estilos base consistentes (Deep Blue & Glass) */
    :root { --bg:#020617; --glass:rgba(30,41,59,0.7); --border:rgba(255,255,255,0.1); --gold:#f59e0b; --text:#f8fafc; --blue:#3b82f6; }
    body { background:var(--bg); color:var(--text); font-family:system-ui, sans-serif; padding:20px; }
    
    .nav { display:flex; gap:15px; align-items:center; margin-bottom:20px; }
    .btn-back { background:rgba(255,255,255,0.1); border:none; color:white; width:40px; height:40px; border-radius:12px; font-size:1.2em; cursor:pointer; }

    .card { background:var(--glass); border:1px solid var(--border); padding:15px; border-radius:16px; margin-bottom:10px; cursor:pointer; display:flex; align-items:center; gap:15px; transition:0.2s; backdrop-filter:blur(10px); }
    .card:active { transform:scale(0.98); background:rgba(245,158,11,0.1); }
    
    .avatar { width:45px; height:45px; background:#1e293b; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:1.1em; }

    /* Contenedor de Estrellas */
    .rating-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .rating-box { background:var(--glass); padding:12px; border-radius:16px; border:1px solid var(--border); display:flex; flex-direction:column; align-items:center; }
    .rating-label { font-size: 0.8em; color: #94a3b8; margin-bottom: 5px; }
    
    .stars { display:flex; gap:5px; font-size:1.2em; cursor:pointer; }
    .star { color:#334155; transition:0.2s; }
    .star.active { color:var(--gold); transform: scale(1.1); }

    textarea { width:100%; background:#0f172a; border:1px solid #334155; color:white; padding:15px; border-radius:12px; min-height:80px; font-family:inherit; outline:none; }
    
    .btn-submit { width:100%; padding:15px; background:linear-gradient(135deg, #f59e0b, #d97706); border:none; border-radius:16px; color:white; font-weight:bold; font-size:1em; margin-top:15px; cursor:pointer; }
    .btn-submit:active { opacity: 0.9; }
  </style>
</head>
<body>

  <div id="viewChannels">
    <div class="nav"><a href="admin.html" class="btn-back" style="display:flex;align-items:center;justify-content:center;text-decoration:none;">‚Üê</a> <h2>Evaluar Equipo</h2></div>
    <div id="channelList">Cargando canales...</div>
  </div>

  <div id="viewAdmins" style="display:none;">
    <div class="nav"><button class="btn-back" onclick="showView('viewChannels')">‚Üê</button> <h2 id="lblChannel">Admins</h2></div>
    <div id="adminList"></div>
  </div>

  <div id="viewRate" style="display:none;">
    <div class="nav"><button class="btn-back" onclick="showView('viewAdmins')">‚Üê</button> <h2 id="lblAdmin">Evaluar</h2></div>
    
    <div style="background:var(--glass); border-radius:20px; padding:10px; margin-bottom:15px; border:1px solid var(--border);">
      <div id="radarChart"></div>
    </div>

    <div class="rating-container">
      
      <div class="rating-box">
        <span class="rating-label">Publicaciones</span>
        <div class="stars" id="s_posts">
          <span onclick="rate('posts',1)">‚òÖ</span><span onclick="rate('posts',2)">‚òÖ</span><span onclick="rate('posts',3)">‚òÖ</span><span onclick="rate('posts',4)">‚òÖ</span><span onclick="rate('posts',5)">‚òÖ</span>
        </div>
      </div>

      <div class="rating-box">
        <span class="rating-label">Actividad Diaria</span>
        <div class="stars" id="s_activity">
          <span onclick="rate('activity',1)">‚òÖ</span><span onclick="rate('activity',2)">‚òÖ</span><span onclick="rate('activity',3)">‚òÖ</span><span onclick="rate('activity',4)">‚òÖ</span><span onclick="rate('activity',5)">‚òÖ</span>
        </div>
      </div>

      <div class="rating-box">
        <span class="rating-label">Dise√±o / Estructura</span>
        <div class="stars" id="s_design">
          <span onclick="rate('design',1)">‚òÖ</span><span onclick="rate('design',2)">‚òÖ</span><span onclick="rate('design',3)">‚òÖ</span><span onclick="rate('design',4)">‚òÖ</span><span onclick="rate('design',5)">‚òÖ</span>
        </div>
      </div>

      <div class="rating-box">
        <span class="rating-label">Originalidad</span>
        <div class="stars" id="s_originality">
          <span onclick="rate('originality',1)">‚òÖ</span><span onclick="rate('originality',2)">‚òÖ</span><span onclick="rate('originality',3)">‚òÖ</span><span onclick="rate('originality',4)">‚òÖ</span><span onclick="rate('originality',5)">‚òÖ</span>
        </div>
      </div>

      <div class="rating-box">
        <span class="rating-label">Trabajo en Equipo</span>
        <div class="stars" id="s_teamwork">
          <span onclick="rate('teamwork',1)">‚òÖ</span><span onclick="rate('teamwork',2)">‚òÖ</span><span onclick="rate('teamwork',3)">‚òÖ</span><span onclick="rate('teamwork',4)">‚òÖ</span><span onclick="rate('teamwork',5)">‚òÖ</span>
        </div>
      </div>

      <div class="rating-box">
        <span class="rating-label">Comunicaci√≥n</span>
        <div class="stars" id="s_comms">
          <span onclick="rate('comms',1)">‚òÖ</span><span onclick="rate('comms',2)">‚òÖ</span><span onclick="rate('comms',3)">‚òÖ</span><span onclick="rate('comms',4)">‚òÖ</span><span onclick="rate('comms',5)">‚òÖ</span>
        </div>
      </div>

    </div>

    <textarea id="feedback" placeholder="Escribe un feedback para el admin (se enviar√° por privado)..."></textarea>
    <button class="btn-submit" onclick="submitRating()">Enviar Evaluaci√≥n</button>
  </div>

  <script>
    // ‚ö†Ô∏è CREDENCIALES
    const sbUrl = 'https://ndkupidhlauzroduvech.supabase.co';
    const sbKey = 'sb_publishable_fSQ9uBUx_YTfxr2QL2-kfQ_pdE2cqHv';
    
    let supabase;
    try { supabase = window.supabase.createClient(sbUrl, sbKey); } catch(e) { alert("Error Supabase"); }

    const tg = window.Telegram.WebApp;
    tg.expand();

    // Estado
    let currentAdminId = 0;
    // Valores por defecto
    let scores = { posts:3, activity:3, design:3, originality:3, teamwork:3, comms:3 };
    let chartInstance = null;

    // 1. CARGAR CANALES
    async function init() {
      const user = tg.initDataUnsafe?.user;
      const userId = user ? user.id : 1298554649; // Fallback

      const list = document.getElementById('channelList');
      
      const { data: channels, error } = await supabase
        .from('managed_channels')
        .select('*')
        .eq('user_id', userId);

      if (error || !channels || channels.length === 0) {
        list.innerHTML = `<div style="text-align:center; padding:20px; color:#94a3b8">
          No hay canales.<br>Aseg√∫rate de ejecutar <code>/sync</code> en tu grupo.
        </div>`;
        return;
      }
      
      list.innerHTML = '';
      channels.forEach(c => {
        const safeTitle = c.chat_title.replace(/'/g, "\\'");
        list.innerHTML += `
        <div class="card" onclick="loadAdmins(${c.telegram_chat_id}, '${safeTitle}')">
          <div class="avatar">üì¢</div> 
          <div style="flex:1"><b>${c.chat_title}</b></div>
          <div style="color:var(--gold)">Abrir ></div>
        </div>`;
      });
    }

    // 2. CARGAR ADMINS
    async function loadAdmins(chatId, title) {
      showView('viewAdmins');
      document.getElementById('lblChannel').innerText = title;
      const list = document.getElementById('adminList');
      list.innerHTML = 'Cargando...';

      const { data: admins, error } = await supabase
        .from('channel_admins')
        .select('*')
        .eq('channel_id', chatId);
      
      if (!admins || admins.length === 0) {
        list.innerHTML = '<div style="text-align:center; padding:20px; color:#94a3b8">No hay admins en este canal.</div>';
        return;
      }

      list.innerHTML = '';
      admins.forEach(a => {
        // Escapar nombre
        const safeName = (a.first_name || 'User').replace(/'/g, "\\'");
        
        list.innerHTML += `
        <div class="card" onclick="openRate(${a.id}, '${safeName}')">
          <div class="avatar">${safeName[0]}</div>
          <div style="flex:1">
            <b>${safeName}</b><br>
            <small style="color:#94a3b8">${a.role || 'Admin'}</small>
          </div>
          <div style="color:var(--gold)">‚òÖ Evaluar</div>
        </div>`;
      });
    }

    // 3. ABRIR FORMULARIO DE EVALUACI√ìN
    function openRate(id, name) {
      currentAdminId = id;
      showView('viewRate');
      document.getElementById('lblAdmin').innerText = name;
      
      // Reset Scores
      scores = { posts:0, activity:0, design:0, originality:0, teamwork:0, comms:0 };
      resetStars(); // Limpia visualmente las estrellas
      updateChart(); // Dibuja la gr√°fica vac√≠a o por defecto
    }

    // 4. L√ìGICA DE ESTRELLAS
    function rate(type, val) {
      scores[type] = val;
      
      // Actualizar UI
      const container = document.getElementById('s_' + type);
      const stars = container.children;
      for(let i=0; i<5; i++) {
        stars[i].classList.remove('active');
        if(i < val) stars[i].classList.add('active');
      }

      // Actualizar Gr√°fica en tiempo real
      updateChart();
      if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
    }

    function resetStars() {
      document.querySelectorAll('.star').forEach(s => s.classList.remove('active'));
    }

    // 5. ENVIAR A SUPABASE
    async function submitRating() {
      const btn = document.querySelector('.btn-submit');
      btn.innerText = "Enviando...";

      // Validar que haya votado
      if(Object.values(scores).some(v => v === 0)) {
        tg.showAlert("Por favor, califica todas las categor√≠as.");
        btn.innerText = "Enviar Evaluaci√≥n";
        return;
      }

      const { error } = await supabase.from('admin_ratings').insert({
        admin_id: currentAdminId,
        rated_by: tg.initDataUnsafe?.user?.id, // ID de quien eval√∫a
        score_posts: scores.posts,
        score_activity: scores.activity,
        score_design: scores.design,
        score_originality: scores.originality,
        score_teamwork: scores.teamwork,
        score_comms: scores.comms,
        feedback_text: document.getElementById('feedback').value
      });

      if(!error) {
        if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        tg.showAlert("¬°Evaluaci√≥n guardada correctamente!");
        showView('viewAdmins');
      } else {
        alert("Error al guardar: " + error.message);
      }
      btn.innerText = "Enviar Evaluaci√≥n";
    }

    // 6. GR√ÅFICA RADAR
    function updateChart() {
      const dataValues = [
        scores.posts, 
        scores.activity, 
        scores.design, 
        scores.originality, 
        scores.teamwork, 
        scores.comms
      ];

      // Datos dummy para comparaci√≥n (Promedio del canal)
      const avgData = [3, 4, 3, 2, 4, 3]; 

      const options = {
        series: [
          { name: 'Tu Evaluaci√≥n', data: dataValues },
          { name: 'Promedio Global', data: avgData }
        ],
        chart: { type: 'radar', height: 250, toolbar:{show:false}, background:'transparent' },
        labels: ['Posts', 'Actividad', 'Dise√±o', 'Originalidad', 'Equipo', 'Comms'],
        colors: ['#f59e0b', '#334155'], // Dorado vs Gris
        stroke: { width: 2, colors: ['#f59e0b', '#475569'] },
        fill: { opacity: 0.2 },
        markers: { size: 3 },
        theme: { mode: 'dark' },
        yaxis: { show: false, max: 5 },
        xaxis: { 
          labels: { 
            style: { 
              colors: ['#94a3b8', '#94a3b8', '#94a3b8', '#94a3b8', '#94a3b8', '#94a3b8'],
              fontSize: '11px'
            } 
          } 
        }
      };

      const chartDiv = document.querySelector("#radarChart");
      chartDiv.innerHTML = "";
      chartInstance = new ApexCharts(chartDiv, options);
      chartInstance.render();
    }

    function showView(id) {
      ['viewChannels', 'viewAdmins', 'viewRate'].forEach(v => document.getElementById(v).style.display = 'none');
      document.getElementById(id).style.display = 'block';
    }

    // Arrancar
    init();
  </script>
</body>
</html>
