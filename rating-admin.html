<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Admin Rating</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    :root { --bg:#020617; --glass:rgba(15,23,42,0.9); --gold:#f59e0b; }
    body { background:var(--bg); color:#f8fafc; font-family:'Inter', sans-serif; padding:20px; }
    
    .nav { margin-bottom:20px; display:flex; gap:15px; align-items:center;}
    .back { text-decoration:none; color:white; font-size:1.5em;}

    /* Star Rating */
    .rating-group { margin-bottom:20px; background:var(--glass); padding:15px; border-radius:16px; border:1px solid rgba(255,255,255,0.1); }
    .stars { display:flex; gap:10px; font-size:1.5em; margin-top:5px; cursor:pointer; }
    .star { color:#334155; transition:0.2s; }
    .star.active { color:var(--gold); }

    textarea { width:100%; background:#0f172a; border:1px solid #334155; color:white; padding:15px; border-radius:12px; min-height:100px; margin-bottom:20px; }

    .btn-submit { width:100%; padding:16px; background:linear-gradient(135deg, #f59e0b, #d97706); border:none; border-radius:16px; color:white; font-weight:bold; font-size:1.1em; }
  </style>
</head>
<body>

  <div id="selectView">
    <div class="nav"><a href="admin.html" class="back">←</a> <h2>Evaluar Desempeño</h2></div>
    <div id="adminsList">Cargando admins...</div>
  </div>

  <div id="rateView" style="display:none;">
    <div class="nav"><span onclick="closeRate()" class="back" style="cursor:pointer">←</span> <h2 id="targetName">Admin</h2></div>
    
    <div style="height:250px; margin-bottom:20px;">
      <div id="radarChart"></div>
    </div>

    <div class="rating-group">
      <label>Actividad Diaria</label>
      <div class="stars" id="star_activity">
        <span onclick="rate(1, 'activity')">★</span><span onclick="rate(2, 'activity')">★</span><span onclick="rate(3, 'activity')">★</span><span onclick="rate(4, 'activity')">★</span><span onclick="rate(5, 'activity')">★</span>
      </div>
    </div>

    <div class="rating-group">
      <label>Comunicación</label>
      <div class="stars" id="star_comms">
        <span onclick="rate(1, 'comms')">★</span><span onclick="rate(2, 'comms')">★</span><span onclick="rate(3, 'comms')">★</span><span onclick="rate(4, 'comms')">★</span><span onclick="rate(5, 'comms')">★</span>
      </div>
    </div>

    <div class="rating-group">
      <label>Trabajo en Equipo</label>
      <div class="stars" id="star_team">
        <span onclick="rate(1, 'team')">★</span><span onclick="rate(2, 'team')">★</span><span onclick="rate(3, 'team')">★</span><span onclick="rate(4, 'team')">★</span><span onclick="rate(5, 'team')">★</span>
      </div>
    </div>

    <label>Feedback Privado (Se enviará al DM)</label>
    <textarea id="feedbackText" placeholder="Escribe tu valoración..."></textarea>

    <button class="btn-submit" onclick="submitRating()">Enviar Evaluación</button>
  </div>

  <script>
    const sbUrl = 'https://ndkupidhlauzroduvech.supabase.co';
    const sbKey = 'sb_publishable_fSQ9uBUx_YTfxr2QL2-kfQ_pdE2cqHv';
    const supabase = window.supabase.createClient(sbUrl, sbKey);
    
    let scores = { activity:0, comms:0, team:0 };
    let selectedAdminId = 0;

    // Cargar Admins
    async function init() {
      const { data } = await supabase.from('channel_admins').select('*');
      const container = document.getElementById('adminsList');
      container.innerHTML = '';
      data.forEach(a => {
        container.innerHTML += `<div style="padding:15px; background:rgba(255,255,255,0.05); margin-bottom:10px; border-radius:12px; cursor:pointer;" onclick="openRate('${a.first_name}', ${a.id})">
          <b>${a.first_name}</b> <span style="float:right">Evaluar ></span>
        </div>`;
      });
    }

    function openRate(name, id) {
      selectedAdminId = id;
      document.getElementById('targetName').innerText = name;
      document.getElementById('selectView').style.display='none';
      document.getElementById('rateView').style.display='block';
      
      // Render Radar
      new ApexCharts(document.querySelector("#radarChart"), {
        series: [{ name: 'Este Admin', data: [4, 3, 5, 4, 2] }, { name: 'Promedio Canal', data: [3, 3, 3, 3, 3] }],
        chart: { type: 'radar', height: 250, toolbar:{show:false}, background:'transparent' },
        labels: ['Actividad', 'Comms', 'Diseño', 'Originalidad', 'Equipo'],
        theme: { mode: 'dark' },
        stroke: { width: 2 },
        fill: { opacity: 0.2 },
        markers: { size: 0 },
        colors: ['#f59e0b', '#3b82f6']
      }).render();
    }

    function rate(val, type) {
      scores[type] = val;
      const stars = document.getElementById('star_'+type).children;
      for(let i=0; i<5; i++) {
        stars[i].classList.remove('active');
        if(i < val) stars[i].classList.add('active');
      }
    }

    async function submitRating() {
      const text = document.getElementById('feedbackText').value;
      const { error } = await supabase.from('admin_ratings').insert({
        admin_id: selectedAdminId,
        score_activity: scores.activity,
        score_comms: scores.comms,
        score_teamwork: scores.team,
        feedback_text: text
      });

      if(!error) {
        window.Telegram.WebApp.showAlert("Evaluación enviada con éxito.");
        closeRate();
      } else {
        alert("Error al guardar");
      }
    }

    function closeRate() {
      document.getElementById('rateView').style.display='none';
      document.getElementById('selectView').style.display='block';
    }

    init();
  </script>
</body>
</html>
