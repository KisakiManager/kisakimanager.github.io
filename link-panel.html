<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Link Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <style>
    /* Estilos id√©nticos a admin-panel para consistencia */
    :root { --bg:#020617; --glass:rgba(30,41,59,0.7); --border:rgba(255,255,255,0.1); --green:#10b981; --text:#f8fafc; --blue:#3b82f6; }
    body { background:var(--bg); color:var(--text); font-family:system-ui, sans-serif; padding:20px; }

    .nav { display:flex; gap:15px; align-items:center; margin-bottom:20px; }
    .btn-back { background:rgba(255,255,255,0.1); border:none; color:white; width:40px; height:40px; border-radius:12px; font-size:1.2em; cursor:pointer; }

    .card { background:var(--glass); border:1px solid var(--border); padding:15px; border-radius:16px; margin-bottom:10px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; transition:0.2s; backdrop-filter:blur(10px); }
    .card:active { transform:scale(0.98); background:rgba(16,185,129,0.1); }

    .input-group { margin-bottom:15px; }
    .input-group label { display:block; color:#94a3b8; font-size:0.85em; margin-bottom:5px; }
    .input-field { width:100%; background:#0f172a; border:1px solid #334155; padding:12px; border-radius:10px; color:white; outline:none; font-size:1em; }

    .fab { position:fixed; bottom:30px; right:30px; width:56px; height:56px; background:var(--green); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.8em; color:white; box-shadow:0 10px 25px rgba(16,185,129,0.3); border:none; cursor:pointer; z-index:100; }
    .fab:active { transform:scale(0.9); }

    .btn-create { width:100%; padding:15px; background:var(--green); border:none; border-radius:16px; color:black; font-weight:bold; font-size:1em; margin-top:10px; cursor:pointer; }

    #userInfo { font-size: 0.8em; color: #64748b; margin-bottom: 15px; text-align: center; }
  </style>
</head>
<body>

  <div id="userInfo">Cargando identidad...</div>

  <div id="viewChannels">
    <div class="nav">
      <a href="admin.html" class="btn-back" style="display:flex;align-items:center;justify-content:center;text-decoration:none;">‚Üê</a>
      <h2>Selecciona Canal</h2>
    </div>
    <div id="channelList">Cargando canales...</div>
  </div>

  <div id="viewLinks" style="display:none;">
    <div class="nav">
      <button class="btn-back" onclick="showView('viewChannels')">‚Üê</button>
      <h2 id="lblChannel">Enlaces</h2>
    </div>

    <div style="background:var(--glass); border-radius:16px; padding:10px; margin-bottom:20px; border:1px solid var(--border);">
      <h4 style="margin:5px 0 10px 5px; color:#94a3b8;">Rendimiento de Enlaces</h4>
      <div id="trafficChart"></div>
    </div>

    <div id="linksContainer"></div>
    <button class="fab" onclick="showView('viewCreate')">+</button>
  </div>

  <div id="viewCreate" style="display:none;">
    <div class="nav">
      <button class="btn-back" onclick="showView('viewLinks')">‚úï</button>
      <h2>Nuevo Enlace</h2>
    </div>

    <div class="input-group">
      <label>Nombre del enlace (Etiqueta)</label>
      <input type="text" id="lnkName" class="input-field" placeholder="Ej: Campa√±a Twitter">
    </div>

    <div class="input-group">
      <label>Tipo de acceso</label>
      <select id="lnkType" class="input-field">
        <option value="direct">‚ö°Ô∏è Directo (Uni√≥n autom√°tica)</option>
        <option value="approve">üîí Requiere Aprobaci√≥n</option>
      </select>
    </div>

    <div class="input-group">
      <label>L√≠mite de usuarios (0 = Infinito)</label>
      <input type="number" id="lnkLimit" class="input-field" value="0">
    </div>

    <button class="btn-create" onclick="createLink()">Generar Enlace</button>
  </div>

  <script>
    // --- TUS CREDENCIALES ---
    const SB_URL = 'https://ndkupidhlauzroduvech.supabase.co'; 
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ka3VwaWRobGF1enJvZHV2ZWNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMzY2NzMsImV4cCI6MjA4NDYxMjY3M30.k6OufxTVTfVimTcUjYJUpLursUGjVtiTgq68xauUKG0';

    const tg = window.Telegram.WebApp;
    tg.expand();

    // Estado Global
    let currentChatId = null; 
    let chartInstance = null;

    // API Wrapper (Conexi√≥n Directa)
    async function apiRequest(endpoint, method = 'GET', body = null) {
      const headers = {
        'apikey': SB_KEY,
        'Authorization': `Bearer ${SB_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      };
      const options = { method, headers };
      if (body) options.body = JSON.stringify(body);

      const response = await fetch(`${SB_URL}/rest/v1/${endpoint}`, options);
      if (!response.ok) {
        // Intentar leer el error detallado del servidor
        const errorText = await response.text();
        throw new Error(`Error API: ${response.status} - ${errorText}`);
      }
      return await response.json();
    }

    // --- PASO 1: CARGAR CANALES ---
    async function loadChannels() {
      const user = tg.initDataUnsafe?.user;
      const infoDiv = document.getElementById('userInfo');
      const list = document.getElementById('channelList');

      if (!user) {
        infoDiv.innerText = "Modo Navegador (Sin ID)";
      } else {
        infoDiv.innerText = `üë§ ${user.first_name} (ID: ${user.id})`;
      }

      try {
        // Usamos el mismo m√©todo que en admin-panel.html
        // Si necesitas filtrar por seguridad, descomenta el filtro de user_id en el futuro
        const channels = await apiRequest('managed_channels?select=*');

        if (channels.length === 0) {
          list.innerHTML = `<div style="text-align:center; padding:20px; color:#94a3b8;">
            No hay canales sincronizados.<br>
            A√±ade el bot a un canal y escribe <code>/sync</code>
          </div>`;
          return;
        }

        list.innerHTML = '';
        channels.forEach(c => {
          const safeTitle = c.chat_title.replace(/'/g, "\\'");
          list.innerHTML += `
          <div class="card" onclick="openChannel(${c.telegram_chat_id}, '${safeTitle}')">
            <div style="font-weight:bold; font-size:1.1em;">üì¢ ${c.chat_title}</div>
            <div style="color:var(--green)">Abrir ></div>
          </div>`;
        });

      } catch (e) {
        list.innerHTML = `<div style="color:red; text-align:center">Error de conexi√≥n:<br>${e.message}</div>`;
      }
    }

    // --- PASO 2: ABRIR CANAL Y CARGAR ENLACES ---
    async function openChannel(chatId, title) {
      currentChatId = chatId;
      document.getElementById('lblChannel').innerText = title;
      showView('viewLinks');
      loadLinks();
    }

    async function loadLinks() {
      const list = document.getElementById('linksContainer');
      list.innerHTML = '<div style="text-align:center; color:#94a3b8">Cargando enlaces...</div>';

      try {
        const links = await apiRequest(`invite_links?select=*&channel_id=eq.${currentChatId}`);

        if (links.length === 0) {
          list.innerHTML = '<div style="text-align:center; padding:20px; color:#94a3b8">No hay enlaces creados a√∫n.</div>';
          renderChart([], []);
          return;
        }

        list.innerHTML = '';
        links.forEach(l => {
          const typeIcon = l.creates_join_request ? 'üîí' : '‚ö°Ô∏è';
          const limitText = l.member_limit > 0 ? `/ ${l.member_limit}` : '';

          list.innerHTML += `
          <div class="card">
            <div>
              <div style="font-weight:bold; font-size:1.1em;">${l.name || 'Sin Etiqueta'}</div>
              <div style="font-size:0.85em; color:#94a3b8; margin-top:4px;">${typeIcon} Creado por: ${l.creator_id}</div>
            </div>
            <div style="text-align:right;">
              <div style="font-weight:bold; color:var(--green); font-size:1.2em;">${l.joins || 0}</div>
              <div style="font-size:0.7em; color:#94a3b8;">UNIONES${limitText}</div>
            </div>
          </div>`;
        });

        const series = links.map(l => l.joins);
        const labels = links.map(l => l.name || 'Link');
        renderChart(series, labels);

      } catch (e) {
        list.innerHTML = `<div style="color:#ef4444">Error: ${e.message}</div>`;
      }
    }

    // --- PASO 3: CREAR ENLACE (CORREGIDO) ---
    async function createLink() {
      const btn = document.querySelector('.btn-create');
      btn.innerText = "Procesando...";

      const name = document.getElementById('lnkName').value;
      const type = document.getElementById('lnkType').value === 'approve'; 
      const limit = parseInt(document.getElementById('lnkLimit').value) || 0;
      const user = tg.initDataUnsafe?.user;

      try {
        // CORRECCI√ìN: Enviamos 'invite_link' como texto pendiente para evitar Error 400
        await apiRequest('invite_links', 'POST', {
          channel_id: currentChatId,
          name: name,
          creates_join_request: type,
          member_limit: limit,
          creator_id: user ? user.id : 0,
          joins: 0,
          invite_link: "PENDING_GENERATION" // <--- CRUCIAL PARA EVITAR ERROR 400
        });

        if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        tg.showAlert("Solicitud enviada. El bot crear√° el enlace en Telegram.");

        // Reset
        showView('viewLinks');
        loadLinks(); 
        document.getElementById('lnkName').value = '';
        document.getElementById('lnkLimit').value = '0';

      } catch (e) {
        tg.showAlert("Error: " + e.message);
      }
      btn.innerText = "Generar Enlace";
    }

    // --- UTILIDADES ---
    function renderChart(series, labels) {
      if(chartInstance) chartInstance.destroy();

      const options = {
        series: [{ name: 'Uniones', data: series }],
        chart: { type: 'bar', height: 150, toolbar:{show:false}, background:'transparent' },
        colors: ['#10b981'],
        plotOptions: { bar: { borderRadius: 4, horizontal: true, distributed: true } },
        dataLabels: { enabled: true },
        xaxis: { categories: labels, labels:{style:{colors:'#94a3b8'}} },
        theme: { mode: 'dark' },
        grid: { show: false }
      };

      chartInstance = new ApexCharts(document.querySelector("#trafficChart"), options);
      chartInstance.render();
    }

    function showView(id) {
      ['viewChannels', 'viewLinks', 'viewCreate'].forEach(v => document.getElementById(v).style.display = 'none');
      document.getElementById(id).style.display = 'block';
    }

    loadChannels();
  </script>
</body>
</html>
