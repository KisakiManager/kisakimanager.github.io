<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Link Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  
  <style>
    /* Estilos id√©nticos a admin-panel para consistencia */
    :root { --bg:#020617; --glass:rgba(30,41,59,0.7); --border:rgba(255,255,255,0.1); --green:#10b981; --text:#f8fafc; }
    body { background:var(--bg); color:var(--text); font-family:system-ui, sans-serif; padding:20px; }
    
    .nav { display:flex; gap:15px; align-items:center; margin-bottom:20px; }
    .btn-back { background:rgba(255,255,255,0.1); border:none; color:white; width:40px; height:40px; border-radius:12px; font-size:1.2em; cursor:pointer; }

    .card { background:var(--glass); border:1px solid var(--border); padding:15px; border-radius:16px; margin-bottom:10px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; transition:0.2s; backdrop-filter:blur(10px); }
    .card:active { transform:scale(0.98); background:rgba(16,185,129,0.1); }
    
    .input-group { margin-bottom:15px; }
    .input-group label { display:block; color:#94a3b8; font-size:0.85em; margin-bottom:5px; }
    .input-field { width:100%; background:#0f172a; border:1px solid #334155; padding:12px; border-radius:10px; color:white; outline:none; font-size:1em; }
    
    .fab { position:fixed; bottom:30px; right:30px; width:56px; height:56px; background:var(--green); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.8em; color:white; box-shadow:0 10px 25px rgba(16,185,129,0.3); border:none; cursor:pointer; z-index:100; }
    .fab:active { transform:scale(0.9); }

    .btn-create { width:100%; padding:15px; background:var(--green); border:none; border-radius:16px; color:black; font-weight:bold; font-size:1em; margin-top:10px; cursor:pointer; }
  </style>
</head>
<body>

  <div id="viewChannels">
    <div class="nav">
      <a href="admin.html" class="btn-back" style="display:flex;align-items:center;justify-content:center;text-decoration:none;">‚Üê</a>
      <h2>Selecciona Canal</h2>
    </div>
    <div id="channelList">Cargando canales...</div>
  </div>

  <div id="viewLinks" style="display:none;">
    <div class="nav">
      <button class="btn-back" onclick="showView('viewChannels')">‚Üê</button>
      <h2 id="lblChannel">Enlaces</h2>
    </div>
    
    <div style="background:var(--glass); border-radius:16px; padding:10px; margin-bottom:20px; border:1px solid var(--border);">
      <h4 style="margin:5px 0 10px 5px; color:#94a3b8;">Rendimiento de Enlaces</h4>
      <div id="trafficChart"></div>
    </div>

    <div id="linksContainer"></div>
    <button class="fab" onclick="showView('viewCreate')">+</button>
  </div>

  <div id="viewCreate" style="display:none;">
    <div class="nav">
      <button class="btn-back" onclick="showView('viewLinks')">‚úï</button>
      <h2>Nuevo Enlace</h2>
    </div>

    <div class="input-group">
      <label>Nombre del enlace (Etiqueta)</label>
      <input type="text" id="lnkName" class="input-field" placeholder="Ej: Campa√±a Twitter">
    </div>

    <div class="input-group">
      <label>Tipo de acceso</label>
      <select id="lnkType" class="input-field">
        <option value="direct">‚ö°Ô∏è Directo (Uni√≥n autom√°tica)</option>
        <option value="approve">üîí Requiere Aprobaci√≥n</option>
      </select>
    </div>

    <div class="input-group">
      <label>L√≠mite de usuarios (0 = Infinito)</label>
      <input type="number" id="lnkLimit" class="input-field" value="0">
    </div>

    <button class="btn-create" onclick="createLink()">Generar Enlace</button>
  </div>

  <script>
    // 1. CONFIGURACI√ìN SUPABASE
    const sbUrl = 'https://ndkupidhlauzroduvech.supabase.co';
    const sbKey = 'sb_publishable_fSQ9uBUx_YTfxr2QL2-kfQ_pdE2cqHv';
    const supabase = window.supabase.createClient(sbUrl, sbKey);
    
    const tg = window.Telegram.WebApp;
    tg.expand();

    // Estado
    let currentChatId = null; 
    let chartInstance = null;

    // --- PASO 1: CARGAR CANALES ---
    async function loadChannels() {
      const user = tg.initDataUnsafe?.user;
      const userId = user ? user.id : 1298554649; // Fallback

      const { data: channels, error } = await supabase
        .from('managed_channels')
        .select('*')
        .eq('user_id', userId);

      const list = document.getElementById('channelList');

      if (error || !channels || channels.length === 0) {
        list.innerHTML = `<div style="text-align:center; padding:20px; color:#94a3b8;">
          No tienes canales gestionados.<br>
          A√±ade el bot a un canal y escribe <code>/sync</code>
        </div>`;
        return;
      }

      list.innerHTML = '';
      channels.forEach(c => {
        // Escapar comillas para evitar bugs en el onclick
        const safeTitle = c.chat_title.replace(/'/g, "\\'");
        
        list.innerHTML += `
        <div class="card" onclick="openChannel(${c.telegram_chat_id}, '${safeTitle}')">
          <div style="font-weight:bold; font-size:1.1em;">üì¢ ${c.chat_title}</div>
          <div style="color:var(--green)">Abrir ></div>
        </div>`;
      });
    }

    // --- PASO 2: ABRIR CANAL Y CARGAR ENLACES ---
    async function openChannel(chatId, title) {
      currentChatId = chatId; // Guardamos el ID para usarlo al crear
      document.getElementById('lblChannel').innerText = title;
      showView('viewLinks');
      
      loadLinks();
    }

    async function loadLinks() {
      const list = document.getElementById('linksContainer');
      list.innerHTML = '<div style="text-align:center; color:#94a3b8">Cargando datos...</div>';

      const { data: links, error } = await supabase
        .from('invite_links')
        .select('*')
        .eq('channel_id', currentChatId);

      if (error) {
        list.innerHTML = `<div style="color:#ef4444">Error: ${error.message}</div>`;
        return;
      }

      if (!links || links.length === 0) {
        list.innerHTML = '<div style="text-align:center; padding:20px; color:#94a3b8">No hay enlaces creados a√∫n.</div>';
        renderChart([], []);
        return;
      }

      // Render Lista
      list.innerHTML = '';
      links.forEach(l => {
        const typeIcon = l.creates_join_request ? 'üîí' : '‚ö°Ô∏è';
        const limitText = l.member_limit > 0 ? `/ ${l.member_limit}` : '';
        
        list.innerHTML += `
        <div class="card">
          <div>
            <div style="font-weight:bold; font-size:1.1em;">${l.name || 'Sin Etiqueta'}</div>
            <div style="font-size:0.85em; color:#94a3b8; margin-top:4px;">${typeIcon} Creado por: ${l.creator_id}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-weight:bold; color:var(--green); font-size:1.2em;">${l.joins}</div>
            <div style="font-size:0.7em; color:#94a3b8;">UNIONES${limitText}</div>
          </div>
        </div>`;
      });

      // Render Gr√°fica Real
      const series = links.map(l => l.joins);
      const labels = links.map(l => l.name || 'Link');
      renderChart(series, labels);
    }

    // --- PASO 3: CREAR ENLACE ---
    async function createLink() {
      const btn = document.querySelector('.btn-create');
      btn.innerText = "Procesando...";

      const name = document.getElementById('lnkName').value;
      const type = document.getElementById('lnkType').value === 'approve'; // true/false
      const limit = parseInt(document.getElementById('lnkLimit').value) || 0;
      
      const user = tg.initDataUnsafe?.user;

      // Insertar en Supabase
      const { error } = await supabase.from('invite_links').insert({
        channel_id: currentChatId, // ID Real del canal seleccionado
        name: name,
        creates_join_request: type,
        member_limit: limit,
        creator_id: user ? user.id : 0,
        joins: 0 // Inicia en 0
      });

      if (error) {
        tg.showAlert("Error: " + error.message);
        btn.innerText = "Error ‚ùå";
      } else {
        if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        tg.showAlert("Solicitud enviada. El bot crear√° el enlace en Telegram.");
        
        // Volver y recargar
        showView('viewLinks');
        loadLinks(); 
        btn.innerText = "Generar Enlace";
        
        // Limpiar inputs
        document.getElementById('lnkName').value = '';
        document.getElementById('lnkLimit').value = '0';
      }
    }

    // --- UTILIDADES ---
    function renderChart(series, labels) {
      if(chartInstance) chartInstance.destroy();
      
      const options = {
        series: [{ name: 'Uniones', data: series }],
        chart: { type: 'bar', height: 150, toolbar:{show:false}, background:'transparent' },
        colors: ['#10b981'],
        plotOptions: { bar: { borderRadius: 4, horizontal: true, distributed: true } },
        dataLabels: { enabled: true },
        xaxis: { categories: labels, labels:{style:{colors:'#94a3b8'}} },
        theme: { mode: 'dark' },
        grid: { show: false }
      };
      
      chartInstance = new ApexCharts(document.querySelector("#trafficChart"), options);
      chartInstance.render();
    }

    function showView(id) {
      ['viewChannels', 'viewLinks', 'viewCreate'].forEach(v => document.getElementById(v).style.display = 'none');
      document.getElementById(id).style.display = 'block';
    }

    // Iniciar
    loadChannels();
  </script>
</body>
</html>
