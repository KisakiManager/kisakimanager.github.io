<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Kisaki Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body { background-color: #0f172a; color: #e2e8f0; padding-bottom: 100px; }

    /* Header */
    .page-header { padding: 20px; background: #1e293b; border-bottom: 1px solid rgba(255,255,255,0.05); }

    /* SELECTORES */
    .selector-row { display: flex; gap: 10px; padding: 15px; overflow-x: auto; }
    .select-box {
      background: #1e293b; border: 1px solid #334155; color: white;
      padding: 10px; border-radius: 8px; width: 100%; font-size: 0.9em;
    }

    /* EDITOR √ÅREA */
    .editor-container { padding: 15px; }
    
    .input-label { font-size: 0.8em; color: #94a3b8; margin-bottom: 5px; display: block; }
    
    .text-editor {
      width: 100%; height: 150px; background: #1e293b; border: 1px solid #334155;
      color: white; padding: 15px; border-radius: 12px; font-family: inherit;
      resize: vertical; outline: none; line-height: 1.5;
    }
    .text-editor:focus { border-color: #6366f1; }

    /* BOTONES */
    .btn-toolbar { display: flex; gap: 5px; margin-bottom: 10px; }
    .tool-btn {
      background: #334155; border: none; color: white; width: 30px; height: 30px;
      border-radius: 6px; cursor: pointer; font-weight: bold;
    }
    
    /* PREVIEW (Estilo Telegram) */
    .preview-box {
      margin: 20px 15px; background: #1e293b; border-radius: 12px 12px 12px 0;
      padding: 10px; position: relative; border: 1px solid rgba(255,255,255,0.05);
      max-width: 85%;
    }
    .preview-header { font-size: 0.8em; color: #6366f1; font-weight: bold; margin-bottom: 5px; }
    .preview-content { white-space: pre-wrap; font-size: 0.95em; }
    .preview-time { text-align: right; font-size: 0.7em; color: #64748b; margin-top: 5px; }
    
    /* Botones Inline Preview */
    .preview-buttons { display: flex; flex-direction: column; gap: 5px; margin-top: 10px; }
    .p-btn {
      background: rgba(255,255,255,0.1); text-align: center; padding: 8px;
      border-radius: 8px; font-size: 0.9em; color: #60a5fa; font-weight: 500;
    }

    /* ACCIONES */
    .fab-send {
      position: fixed; bottom: 20px; right: 20px;
      width: 56px; height: 56px;
      background: #6366f1; color: white;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); cursor: pointer;
    }

    /* URL MEDIA INPUT */
    .media-input {
      width: 100%; background: #0f172a; border: 1px solid #334155;
      color: white; padding: 10px; border-radius: 8px; margin-bottom: 15px;
    }

  </style>
</head>
<body>

  <div class="page-header">
    <a href="index.html" style="color:#94a3b8; text-decoration:none; font-size:0.9em;">‚Üê Inicio</a>
    <h1 style="margin:5px 0 0 0; font-size:1.6em;">Studio Creativo</h1>
  </div>

  <div class="selector-row">
    <select id="botSelector" class="select-box" onchange="loadChannels()">
      <option value="">Selecciona un Bot...</option>
    </select>
  </div>
  <div class="selector-row" style="padding-top:0;">
    <input type="text" id="targetChannel" class="select-box" placeholder="ID del Canal (ej: -100123...)" value="-1003099743186">
  </div>

  <div class="editor-container">
    <span class="input-label">Contenido del Post (HTML Soportado)</span>
    <div class="btn-toolbar">
      <button class="tool-btn" onclick="insertTag('<b>', '</b>')">B</button>
      <button class="tool-btn" style="font-style:italic;" onclick="insertTag('<i>', '</i>')">I</button>
      <button class="tool-btn" onclick="insertTag('<code>', '</code>')">&lt;/&gt;</button>
      <button class="tool-btn" onclick="insertTag('<a href=\'\'>', '</a>')">üîó</button>
    </div>
    <textarea id="postContent" class="text-editor" placeholder="Escribe aqu√≠ tu obra maestra..." oninput="updatePreview()"></textarea>
    
    <span class="input-label" style="margin-top:15px;">Multimedia (URL de Imagen/Video)</span>
    <input type="text" id="mediaUrl" class="media-input" placeholder="https://..." oninput="updatePreview()">

    <span class="input-label">Botones (Formato: Texto|URL, uno por l√≠nea)</span>
    <textarea id="buttonsConfig" class="media-input" style="height:80px;" placeholder="Ver Web|https://google.com&#10;Soporte|https://t.me/mi_user" oninput="updatePreview()"></textarea>
  </div>

  <h3 style="margin-left:15px; font-size:0.9em; color:#64748b; text-transform:uppercase;">Vista Previa</h3>
  <div class="preview-box">
    <div id="previewMedia" style="margin-bottom:10px; display:none;">
        <img src="" style="width:100%; border-radius:8px;" id="pImg">
    </div>
    <div class="preview-header" id="previewBotName">Bot Name</div>
    <div class="preview-content" id="previewText">...</div>
    <div class="preview-buttons" id="previewBtns"></div>
    <div class="preview-time">Ahora</div>
  </div>

  <div class="fab-send" onclick="sendPost()">
    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    const user = tg.initDataUnsafe?.user;
    const OWNER_ID = user ? user.id : 1298554649; 

    const SUPABASE_URL = 'https://ndkupidhlauzroduvech.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_fSQ9uBUx_YTfxr2QL2-kfQ_pdE2cqHv'; 
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let botsList = [];

    // 1. CARGAR BOTS DISPONIBLES
    async function init() {
        const { data } = await supabase.from('bots').select('*').eq('owner_id', OWNER_ID).eq('status', 'active');
        if(data) {
            botsList = data;
            const select = document.getElementById('botSelector');
            data.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b.id;
                opt.text = b.bot_username || "Bot Sin Nombre";
                select.appendChild(opt);
            });
        }
    }

    // 2. ACTUALIZAR PREVIEW EN TIEMPO REAL
    function updatePreview() {
        const text = document.getElementById('postContent').value;
        const media = document.getElementById('mediaUrl').value;
        const btns = document.getElementById('buttonsConfig').value;
        
        // Texto
        document.getElementById('previewText').innerHTML = text.replace(/\n/g, '<br>');
        
        // Media
        const pImg = document.getElementById('pImg');
        const pMedia = document.getElementById('previewMedia');
        if(media) {
            pImg.src = media;
            pMedia.style.display = 'block';
        } else {
            pMedia.style.display = 'none';
        }
        
        // Botones
        const btnContainer = document.getElementById('previewBtns');
        btnContainer.innerHTML = '';
        if(btns) {
            const lines = btns.split('\n');
            lines.forEach(line => {
                const parts = line.split('|');
                if(parts.length > 0 && parts[0].trim() !== "") {
                    const b = document.createElement('div');
                    b.className = 'p-btn';
                    b.innerText = parts[0];
                    btnContainer.appendChild(b);
                }
            });
        }

        // Nombre del bot
        const sel = document.getElementById('botSelector');
        if(sel.selectedIndex > 0) {
            document.getElementById('previewBotName').innerText = sel.options[sel.selectedIndex].text;
        }
    }

    // 3. HERRAMIENTAS EDITOR
    function insertTag(start, end) {
        const el = document.getElementById('postContent');
        const s = el.selectionStart;
        const e = el.selectionEnd;
        const val = el.value;
        el.value = val.substring(0, s) + start + val.substring(s, e) + end + val.substring(e);
        updatePreview();
    }

    // 4. ENVIAR A LA COLA (SUPABASE)
    async function sendPost() {
        const botId = document.getElementById('botSelector').value;
        const chatId = document.getElementById('targetChannel').value;
        const content = document.getElementById('postContent').value;
        const media = document.getElementById('mediaUrl').value;
        const btnsRaw = document.getElementById('buttonsConfig').value;

        if(!botId || !chatId || !content) return alert("Falta Bot, Canal o Mensaje.");

        // Procesar botones a JSON
        let buttonsJson = [];
        if(btnsRaw) {
            const lines = btnsRaw.split('\n');
            lines.forEach(l => {
                const p = l.split('|');
                if(p.length >= 2) buttonsJson.push([{text: p[0], url: p[1].trim()}]);
            });
        }

        const btn = document.querySelector('.fab-send');
        btn.style.opacity = 0.5;

        const { error } = await supabase.from('studio_posts').insert({
            user_id: OWNER_ID,
            bot_id: botId,
            target_chat_id: chatId,
            content: content,
            media_url: media,
            buttons_config: buttonsJson,
            status: 'pending' // Esto le dice al bot "¬°Hay trabajo!"
        });

        if(error) {
            alert("Error: " + error.message);
        } else {
            tg.showPopup({ title: '¬°Enviado!', message: 'El post est√° en la cola de procesamiento.', buttons: [{type: 'ok'}] });
            document.getElementById('postContent').value = '';
        }
        btn.style.opacity = 1;
    }

    init();
  </script>
</body>
</html>
